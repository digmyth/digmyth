<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Welcome to wxq&#39;s Blog created in 2017-01-01</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Welcome to wxq&#39;s Blog created in 2017-01-01">
<meta property="og:url" content="http://www.digmyth.com/page/2/index.html">
<meta property="og:site_name" content="Welcome to wxq&#39;s Blog created in 2017-01-01">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Welcome to wxq&#39;s Blog created in 2017-01-01">
  
    <link rel="alternate" href="/atom.xml" title="Welcome to wxq&#39;s Blog created in 2017-01-01" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Welcome to wxq&#39;s Blog created in 2017-01-01</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.digmyth.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-linux-disk" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/15/linux-disk/" class="article-date">
  <time datetime="2019-12-15T01:42:54.000Z" itemprop="datePublished">2019-12-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/15/linux-disk/">linux disk</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Ubuntu系统分区信息查看：<code>fdisk /dev/vda</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Command (m for help): p</span><br><span class="line">Disk /dev/vda: 60 GiB, 64424509440 bytes, 125829120 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel type: dos</span><br><span class="line">Disk identifier: 0x630fdccb</span><br><span class="line"></span><br><span class="line">Device     Boot   Start       End   Sectors  Size Id Type</span><br><span class="line">/dev/vda1  *       2048   1953791   1951744  953M 83 Linux</span><br><span class="line">/dev/vda2       1953792 125829119 123875328 59.1G 83 Linux</span><br></pre></td></tr></table></figure></p>
<p>Sart、End、Sectors单位都是扇区， 1扇区=512bytes，那么2扇区就是1KB 通常称为一个block块，那么就有了<code>2sectors=1KB=1 block</code>,可以通过<code>blockdev --getsz /dev/vda</code>得到整块盘扇区数<br><code>像上面1953791-2048+1=1951744</code>扇,953M=1951744/2/1024KB</p>
<p>CentOS差别可能就是 Blocks数显示，上面说了1Block=1KB<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Disk /dev/vda: 64.4 GB, 64424509440 bytes, 125829120 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0x000afe6d</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/vda1   *        2048     4196351     2097152   83  Linux</span><br><span class="line">/dev/vda2         4196352   125829119    60816384   83  Linux</span><br></pre></td></tr></table></figure></p>
<p>我来验证一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4196351-2048+1得到扇区数，(4196351-2048+1)/2=2097152刚好等于Blocks数，也就是2097152KB=2048MB=2GB</span><br></pre></td></tr></table></figure></p>
<p>我们再来学习下dd命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bs参数代表逻辑块大小，默认单位是扇区，bs=512代表一个扇区，也就是512bytes</span><br><span class="line">count参数代表逻辑块的个数或扇区数，那么处理的存储大小就是bs*count</span><br><span class="line">skip 表示跳过if 设备的扇区数开始读数据,skip=200代表200个扇区，也就是100KB</span><br><span class="line">seek表示跳过of设备的扇区数开始写数据,seek=400代表400个扇区，也就是200KB</span><br></pre></td></tr></table></figure></p>
<p>那么学了这些有什么用呢？<br>一个裸盘有硬件raid卡信息是不能正常被格式化的，这个raid信息会存在硬盘的最后63个扇区的地方，我们可以用dd复盖掉<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">snumber=$(($(blockdev --getsz /dev/sda)-63))</span><br><span class="line">dd if=/dev/zero of=/dev/sda bs=512 count=63 seek=$snumber</span><br></pre></td></tr></table></figure></p>
<p>总结：</p>
<ul>
<li>一个扇区512bytes , 1Block=1KB=2扇区</li>
<li>dd参数的skip针对if设备，seek针对of设备（跳过多少扇区再处理）</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/12/15/linux-disk/" data-id="ckjsb7huy001t4kjxiyma502d" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-linux-nmap详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/15/linux-nmap详解/" class="article-date">
  <time datetime="2019-12-15T01:42:54.000Z" itemprop="datePublished">2019-12-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/15/linux-nmap详解/">nmap工具详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-1-nmap基础"><a href="#1-1-nmap基础" class="headerlink" title="1.1 nmap基础"></a>1.1 nmap基础</h3><p>在运维过程中有时需要主机存活性探测，一般是namp、tcpdump命令结合使用，相关工具包安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ ]# yum install  nmap tcpdump</span><br></pre></td></tr></table></figure></p>
<p>列出几种nmap命令语法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-sS/sT/sA/sW/sM: TCP SYN/Connect()/ACK/Window/Maimon scans</span><br><span class="line">-sU: UDP Scan</span><br><span class="line">-sP: ping Scan</span><br></pre></td></tr></table></figure></p>
<p>下面我们在2台主机间探测，一主机发nmap探测，另一主机tcpdump抓包分析</p>
<p>在A主机正常发一个ping包看看正常情况下的icmp包<br> ping -c 1 10.17.200.36</p>
<p> 在B主机抓包发现icmp包有去有回<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ ]# tcpdump -np -i ens192 src host 10.17.200.14</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on ens192, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">16:08:38.392418 IP 10.17.200.14 &gt; 10.17.200.36: ICMP echo request, id 5220, seq 1, length 64</span><br><span class="line">16:08:43.400811 ARP, Reply 10.17.200.14 is-at 00:50:56:b9:b2:fb, length 46</span><br></pre></td></tr></table></figure></p>
<p>可在一台主机临时禁用icmp协议,再用ping将探测不到这台主机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all</span><br></pre></td></tr></table></figure></p>
<h3 id="1-2-nmap-ping探测"><a href="#1-2-nmap-ping探测" class="headerlink" title="1.2 nmap ping探测"></a>1.2 nmap ping探测</h3><p>我们开始nmap ping探测， -n表示不进行DNS解析<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ ]# nmap -n -sP 10.17.200.36</span><br><span class="line">Starting Nmap 6.40 ( http://nmap.org ) at 2019-01-15 16:12 CST</span><br><span class="line">Nmap scan report for 10.17.200.36</span><br><span class="line">Host is up (0.00030s latency).</span><br><span class="line">MAC Address: 00:50:56:B9:21:18 (VMware)</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 0.05 seconds</span><br></pre></td></tr></table></figure></p>
<p>在B主机探测发现只收到了对方发的请求包，并未回应，但是还是认为这台主机是存活的，这样提高了探测效率<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost roles]# tcpdump -np -i ens192 src host 10.17.200.14</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on ens192, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">16:12:28.972321 ARP, Request who-has 10.17.200.36 (Broadcast) tell 10.17.200.14, length 46</span><br></pre></td></tr></table></figure></p>
<h3 id="1-3-nmapSYN探测"><a href="#1-3-nmapSYN探测" class="headerlink" title="1.3 nmapSYN探测"></a>1.3 nmapSYN探测</h3><p>我们开始nmap TCP的SYN探测， -n表示不进行DNS解析<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ ]# nmap -n -PE 10.17.200.36</span><br><span class="line">Starting Nmap 6.40 ( http://nmap.org ) at 2019-01-15 16:20 CST</span><br><span class="line">Nmap scan report for 10.17.200.36</span><br><span class="line">Host is up (0.00014s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT    STATE    SERVICE</span><br><span class="line">22/tcp  open     ssh</span><br><span class="line">445/tcp filtered microsoft-ds</span><br><span class="line">MAC Address: 00:50:56:B9:21:18 (VMware)</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 1.33 seconds</span><br></pre></td></tr></table></figure></p>
<p>在B主机探测发现，A主机对B主机的各服务都发送了TCP　SYN包来进行探测<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@　]# tcpdump -np -i ens192 src host 10.17.200.14</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on ens192, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">16:20:07.124327 ARP, Request who-has 10.17.200.36 (Broadcast) tell 10.17.200.14, length 46</span><br><span class="line">16:20:07.148867 IP 10.17.200.14.40911 &gt; 10.17.200.36.rtsp: Flags [S], seq 3791226815, win 1024, options [mss 1460], length 0</span><br><span class="line">16:20:07.148882 IP 10.17.200.14.40911 &gt; 10.17.200.36.smtp: Flags [S], seq 3791226815, win 1024, options [mss 1460], length 0</span><br><span class="line">16:20:07.148906 IP 10.17.200.14.40911 &gt; 10.17.200.36.domain: Flags [S], seq 3791226815, win 1024, options [mss 1460], length 0</span><br><span class="line">16:20:07.148943 IP 10.17.200.14.40911 &gt; 10.17.200.36.https: Flags [S], seq 3791226815, win 1024, options [mss 1460], length 0</span><br><span class="line">16:20:07.148950 IP 10.17.200.14.40911 &gt; 10.17.200.36.mysql: Flags [S], seq 3791226815, win 1024, options [mss 1460], length 0</span><br><span class="line">16:20:07.148950 IP 10.17.200.14.40911 &gt; 10.17.200.36.ssh: Flags [S], seq 3791226815, win 1024, options [mss 1460], length 0</span><br><span class="line">信息太多，略过...</span><br><span class="line">16:20:12.152833 ARP, Reply 10.17.200.14 is-at 00:50:56:b9:b2:fb, length 46</span><br></pre></td></tr></table></figure></p>
<h3 id="1-4-arping"><a href="#1-4-arping" class="headerlink" title="1.4 arping"></a>1.4 arping</h3><p>另外补充一下，<code>arping -D</code>可有效检测IP地址冲突问题,如果命令<code>echo $?</code>返回值为0则表示地址冲突，1则表示不冲突.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ ]# arping  -D  -c 2   -I ens192   10.17.200.36</span><br><span class="line">ARPING 10.17.200.36 from 0.0.0.0 ens192</span><br><span class="line">Unicast reply from 10.17.200.36 [00:50:56:B9:21:18]  0.887ms</span><br><span class="line">Sent 1 probes (1 broadcast(s))</span><br><span class="line">Received 1 response(s)</span><br></pre></td></tr></table></figure></p>
<h3 id="1-5-总结"><a href="#1-5-总结" class="headerlink" title="1.5 总结"></a>1.5 总结</h3><ul>
<li>nmap -sP 可进行ping检测</li>
<li>nmap -PE 可进行tcp SYN检测</li>
<li>nmap -n -sP -PE 可进行ping与SYN结合检测,以免漏扫</li>
<li>arping -D 可进行地址冲突检测</li>
</ul>
<p>&lt;完结&gt;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/12/15/linux-nmap详解/" data-id="ckjsb7hv900254kjxcd46f7mc" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-k8s_pod1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/01/k8s_pod1/" class="article-date">
  <time datetime="2019-12-01T12:51:41.000Z" itemprop="datePublished">2019-12-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器世界/">容器世界</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/01/k8s_pod1/">k8s_pod资源清单学习1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        The article has been encrypted, please enter your password to view.<br>
        
          <p class="article-more-link">
            <a href="/2019/12/01/k8s_pod1/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/12/01/k8s_pod1/" data-id="ckjsb7hui001a4kjxawnlitgm" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-linux-udev" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/15/linux-udev/" class="article-date">
  <time datetime="2019-11-15T01:42:54.000Z" itemprop="datePublished">2019-11-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/15/linux-udev/">udev定义network</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        The article has been encrypted, please enter your password to view.<br>
        
          <p class="article-more-link">
            <a href="/2019/11/15/linux-udev/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/11/15/linux-udev/" data-id="ckjsb7hvf002c4kjxalzu5fx1" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-mariadb-恢复数据" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/25/mariadb-恢复数据/" class="article-date">
  <time datetime="2019-07-25T01:41:54.000Z" itemprop="datePublished">2019-07-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Mysql/">Mysql</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/25/mariadb-恢复数据/">mariadb-恢复数据</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        The article has been encrypted, please enter your password to view.<br>
        
          <p class="article-more-link">
            <a href="/2019/07/25/mariadb-恢复数据/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/07/25/mariadb-恢复数据/" data-id="ckjsb7hvj002g4kjxjt9j65d2" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-Kubernetes-dashboard-TLS坑" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/11/Kubernetes-dashboard-TLS坑/" class="article-date">
  <time datetime="2019-06-11T12:51:41.000Z" itemprop="datePublished">2019-06-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器世界/">容器世界</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/11/Kubernetes-dashboard-TLS坑/">kubernetes-dashboard-TLS坑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        The article has been encrypted, please enter your password to view.<br>
        
          <p class="article-more-link">
            <a href="/2019/06/11/Kubernetes-dashboard-TLS坑/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/06/11/Kubernetes-dashboard-TLS坑/" data-id="ckjsb7htb00034kjx04l4z5su" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-python-Celery-Flask" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/10/python-Celery-Flask/" class="article-date">
  <time datetime="2019-02-10T09:03:01.000Z" itemprop="datePublished">2019-02-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Python/">Python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/10/python-Celery-Flask/">python-celery-Flask</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一、基本使用"><a href="#一、基本使用" class="headerlink" title="一、基本使用"></a>一、基本使用</h3><p>Celery是由Python开发的一个简单、灵活、可靠的处理大量任务的分发系统，可以实时处理任务，也可以定时异步处理任务。<br>每次分发任务后得到一个ID，然后根据这个ID查询任务执行情况。</p>
<p>并且celery需要rabbitMQ、Redis等充当broker来进行消息的接收。</p>
<p>安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install celery eventlet   # windows系统需要eventlet模块</span><br></pre></td></tr></table></figure></p>
<p>下面我们来快速上手celery<br>编辑s1.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery import Celery</span><br><span class="line"></span><br><span class="line">cel = Celery(&apos;xxx&apos;,</span><br><span class="line">             broker=&quot;redis://192.168.1.40&quot;,</span><br><span class="line">             backend=&apos;redis://192.168.1.40&apos;)</span><br><span class="line"></span><br><span class="line">@cel.task</span><br><span class="line">def f1(x,y):</span><br><span class="line">    return x+y</span><br></pre></td></tr></table></figure></p>
<p>然后把s1这个work工作起来，进入命令终端,如果在linux系统，不用添加参数-P eventlet<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\pro\xxx_dir&gt; celery worker -A s1 -l info  -P eventlet</span><br></pre></td></tr></table></figure></p>
<p>编辑s2.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">import datetime</span><br><span class="line">from s1 import f1</span><br><span class="line"></span><br><span class="line"># 立即执行</span><br><span class="line">result = f1.delay(4,6)</span><br><span class="line">print(result.id)</span><br><span class="line"></span><br><span class="line"># 定时执行</span><br><span class="line">ctime = datetime.datetime.now()</span><br><span class="line"># ctime = datetime.datetime(year=2019,month=2,day=21,hour=14,minute=8)</span><br><span class="line">utc_time = datetime.datetime.utcfromtimestamp(ctime.timestamp())</span><br><span class="line">s10 = datetime.timedelta(seconds=10)</span><br><span class="line">ctime_x = utc_time + s10</span><br><span class="line">result = f1.apply_async(args=[1,3],eta=ctime_x)</span><br><span class="line">print(result.id)</span><br></pre></td></tr></table></figure></p>
<p>编辑s3.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery.result import  AsyncResult</span><br><span class="line">from demo1.s1 import cel</span><br><span class="line"></span><br><span class="line">async = AsyncResult(id=&quot;f43bce52-9503-475e-9d19-4a46ed910a8e&quot;,app=cel)</span><br><span class="line"></span><br><span class="line">if async.successful():</span><br><span class="line">    ret = async.get() # 获取值</span><br><span class="line">    #async.forget()  #  删除值</span><br><span class="line">    print(ret)</span><br><span class="line">elif async.failed():</span><br><span class="line">    print(&apos;执行失败&apos;)</span><br><span class="line">elif async.status == &apos;PENDING&apos;:</span><br><span class="line">    print(&apos;任务等待中被执行&apos;)</span><br><span class="line">elif async.status == &apos;RETRY&apos;:</span><br><span class="line">    print(&apos;任务异常后正在重试&apos;)</span><br><span class="line">elif async.status == &apos;STARTED&apos;:</span><br><span class="line">    print(&apos;任务已经开始被执行&apos;)</span><br><span class="line">else:</span><br><span class="line">    print(&quot;任务执行失败&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async.revoke()    #  取消一个任务，当一个任务正在执行，不能取消</span><br><span class="line">async.revoke(terminate=True)  # 终止一个任务，当一个任务正在执行，可以被终止</span><br></pre></td></tr></table></figure></p>
<h3 id="二、多目录结构"><a href="#二、多目录结构" class="headerlink" title="二、多目录结构"></a>二、多目录结构</h3><p>经过上面快速上手的学习，了解了celery的基本使用，那么重组一下代，形成项目中多目录结构看看相互之间如何调用？</p>
<p>创建一个celery_tasks的目录，里面一般保存2类文件，其中一个文件名称必须为celery,另一类就是定义task任务的文件，可以有多个。</p>
<p>定义celery_tasks/celery.py文件,如果有多个task任务文件，可以用includ列表包含进来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery import Celery</span><br><span class="line"># from celery.schedules import crontab</span><br><span class="line"></span><br><span class="line">cel = Celery(&apos;xxxxxx&apos;,</span><br><span class="line">                broker=&apos;redis://192.168.1.40:6379&apos;,</span><br><span class="line">                backend=&apos;redis://192.168.1.40:6379&apos;,</span><br><span class="line">                include=[&apos;celery_tasks.task1&apos;,)</span><br><span class="line">                #include=[&apos;celery_tasks.task1&apos;,&apos;celery_tasks.task2&apos;])</span><br><span class="line"></span><br><span class="line"># 时区</span><br><span class="line">cel.conf.timezone = &apos;Asia/Shanghai&apos;</span><br><span class="line"># 是否使用UTC</span><br><span class="line">cel.conf.enable_utc = False</span><br></pre></td></tr></table></figure></p>
<p>在多目录结构中，跑celery  work时不用指定到文件，指定目录即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\pro\xxx_dir&gt; celery worker -A celery_tasks -l info  -P eventlet</span><br></pre></td></tr></table></figure></p>
<p>定义celery_tasks/task1.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from .celery import cel</span><br><span class="line"></span><br><span class="line">@cel.task</span><br><span class="line">def f1(x,y):</span><br><span class="line">    return  x+y</span><br></pre></td></tr></table></figure></p>
<p>有了celery.py文件和task任务文件，我们就可以在任意地方调用任务了。</p>
<p>比如定义test/exec1.py文件来执行任务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery_tasks.task1 import f1</span><br><span class="line"></span><br><span class="line">result = f1.delay(4,6)</span><br><span class="line">print(result.id)</span><br></pre></td></tr></table></figure></p>
<p>定义test/exec2.py文件来获取任务执行结果,需要提供任务ID<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery_tasks.celery import cel</span><br><span class="line">from celery.result import AsyncResult</span><br><span class="line"></span><br><span class="line">async = AsyncResult(id=&quot;be6bb021-da48-46a9-b1bc-94b987f7c8a7&quot;,app=cel)</span><br><span class="line"></span><br><span class="line">if async.successful():</span><br><span class="line">    print(async.get())</span><br><span class="line">else:</span><br><span class="line">    print(&quot;任务执行失败&quot;)</span><br></pre></td></tr></table></figure></p>
<h3 id="三、Flask中的例用"><a href="#三、Flask中的例用" class="headerlink" title="三、Flask中的例用"></a>三、Flask中的例用</h3><p>有了上面celery的认识，我们来简单写点代码，看一下在Flask框架中celery是如何使用的？</p>
<p>定义Flask项目启动文件app.py</p>
<p>写线上代码时是要把任务保存在数据库中的，这里仅作示例就保存在了HISTORY全局变量中了.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from flask import Flask,request,render_template,redirect</span><br><span class="line"></span><br><span class="line">from celery_tasks.task2 import  deploy</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">HISTORY = []</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/index&apos;,methods=[&quot;GET&quot;,&quot;POST&quot;])</span><br><span class="line">def index():</span><br><span class="line">    if  request.method == &quot;GET&quot;:</span><br><span class="line">        return render_template(&apos;index.html&apos;,history=HISTORY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&apos;/publish&apos;,methods=[&quot;GET&quot;,&quot;POST&quot;])</span><br><span class="line">def publish():</span><br><span class="line">    if  request.method == &quot;GET&quot;:</span><br><span class="line">        return render_template(&apos;publish.html&apos;)</span><br><span class="line">    else:</span><br><span class="line">        version = request.form.get(&quot;version&quot;)</span><br><span class="line">        hosts = request.form.getlist(&quot;hosts&quot;)</span><br><span class="line">        print(version,hosts)</span><br><span class="line"></span><br><span class="line">        import datetime</span><br><span class="line">        ctime = datetime.datetime.now()</span><br><span class="line">        utc_time = datetime.datetime.utcfromtimestamp(ctime.timestamp())</span><br><span class="line">        ctime_10 = utc_time + datetime.timedelta(seconds=10)</span><br><span class="line">        result = deploy.apply_async(args=[version,hosts],eta=ctime_10)</span><br><span class="line">        HISTORY.append(&#123;&quot;version&quot;:version,&quot;hosts&quot;:hosts,&quot;task_id&quot;:result.id&#125;)</span><br><span class="line">        print(HISTORY)</span><br><span class="line">        return redirect(&quot;/index&quot;)</span><br><span class="line"></span><br><span class="line">from celery.result import AsyncResult</span><br><span class="line">from celery_tasks.celery import cel</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/check_result&apos;,methods=[&quot;GET&quot;,&quot;POST&quot;])</span><br><span class="line">def check_result():</span><br><span class="line">    task_id = request.args.get(&quot;task_id&quot;)</span><br><span class="line">    async = AsyncResult(id=task_id,app=cel)</span><br><span class="line">    if async.successful():</span><br><span class="line">        result = async.get()</span><br><span class="line">        print(result)</span><br><span class="line">        # result.forget() # 将结果删除</span><br><span class="line">        return &quot;执行成功&quot;</span><br><span class="line">    elif async.failed():</span><br><span class="line">        return &apos;执行失败&apos;</span><br><span class="line">    elif async.status == &apos;PENDING&apos;:</span><br><span class="line">        return &apos;任务等待中被执行&apos;</span><br><span class="line">    elif async.status == &apos;RETRY&apos;:</span><br><span class="line">        return &apos;任务异常后正在重试&apos;</span><br><span class="line">    elif async.status == &apos;STARTED&apos;:</span><br><span class="line">        return &apos;任务已经开始被执行&apos;</span><br><span class="line">    else:</span><br><span class="line">        return &quot;unkown status&quot;</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/cancel&apos;, methods=[&quot;GET&quot;, &quot;POST&quot;])</span><br><span class="line">def cancel():</span><br><span class="line">    task_id = request.args.get(&quot;task_id&quot;)</span><br><span class="line">    async =AsyncResult(id=task_id,app=cel)</span><br><span class="line">    async.revoke(terminate=True)</span><br><span class="line">    for i in HISTORY:</span><br><span class="line">        if task_id in i.values():</span><br><span class="line">            HISTORY.remove(i)</span><br><span class="line">    return redirect(&quot;/index&quot;)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure></p>
<p>定义其中用到的templates/index.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;发布系统&lt;/h1&gt;</span><br><span class="line">&lt;a href=&quot;/publish&quot;&gt;添加发布任务&lt;/a&gt;</span><br><span class="line">&lt;table&gt;</span><br><span class="line">    &#123;% for row in history %&#125;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">        &lt;td&gt;&#123;&#123; row.task_id &#125;&#125;&lt;/td&gt;</span><br><span class="line">        &lt;td&gt;&#123;&#123; row.version &#125;&#125;&lt;/td&gt;</span><br><span class="line">        &#123;% for host in  row.hosts %&#125;</span><br><span class="line">           &lt;td&gt;</span><br><span class="line">              &lt;span&gt;&#123;&#123; host &#125;&#125;&lt;/span&gt;</span><br><span class="line">           &lt;/td&gt;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">        &lt;td&gt;&lt;a href=&quot;/check_result?task_id=&#123;&#123; row.task_id &#125;&#125;&quot;&gt;查看&lt;/a&gt;&lt;/td&gt;</span><br><span class="line">        &lt;td&gt;&lt;a href=&quot;/cancel?task_id=&#123;&#123; row.task_id &#125;&#125;&quot;&gt;取消&lt;/a&gt;&lt;/td&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>定义其中用到的templates/publish.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span><br><span class="line">    &lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;version&quot; placeholder=&quot;请输入要发布的版本&quot;&gt;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">        &lt;select name=&quot;hosts&quot; multiple=&quot;multiple&quot;&gt;</span><br><span class="line">            &lt;option value=&quot;c1.com&quot;&gt;c1.com&lt;/option&gt;</span><br><span class="line">            &lt;option value=&quot;c2.com&quot;&gt;c2.com&lt;/option&gt;</span><br><span class="line">            &lt;option value=&quot;c3.com&quot;&gt;c3.com&lt;/option&gt;</span><br><span class="line">        &lt;/select&gt;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot; value=&quot;提交&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>定义其中的celery_tasks.task2.py文件,这里的deploy是真正定义任务的地方.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from .celery import cel</span><br><span class="line"></span><br><span class="line">@cel.task</span><br><span class="line">def deploy(version,hosts):</span><br><span class="line">    print(version, hosts) # 定义想要执行的任务代码</span><br><span class="line">    return &apos;deploy ok&apos;</span><br></pre></td></tr></table></figure></p>
<p>同样别望了先把work跑起来,再启动Flask<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\pro\xxx_dir&gt; celery worker -A celery_tasks -l info  -P eventlet</span><br></pre></td></tr></table></figure></p>
<h3 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h3><p>还需要多写代码在项目中总结celery…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/02/10/python-Celery-Flask/" data-id="ckjsb7hwz00414kjxaa6oas8k" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-ansible-Callback-02" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/12/ansible-Callback-02/" class="article-date">
  <time datetime="2019-01-12T12:39:12.000Z" itemprop="datePublished">2019-01-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/ansible/">ansible</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/12/ansible-Callback-02/">ansible callback 重写</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-1-adhoc-callback重写"><a href="#1-1-adhoc-callback重写" class="headerlink" title="1.1 adhoc callback重写"></a>1.1 adhoc callback重写</h3><p>adhoc-callback.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">import os,sys,json</span><br><span class="line">import ansible.constants as C</span><br><span class="line">from ansible.parsing.dataloader import  DataLoader</span><br><span class="line">from ansible.vars.manager import  VariableManager</span><br><span class="line">from ansible.inventory.manager import  InventoryManager</span><br><span class="line">from ansible.playbook import Play</span><br><span class="line">from ansible.executor.task_queue_manager import  TaskQueueManager</span><br><span class="line">from ansible.executor.playbook_executor import  PlaybookExecutor</span><br><span class="line">from ansible.plugins.callback import CallbackBase</span><br><span class="line">from ansible.inventory.host import  Host,Group</span><br><span class="line">from  collections import namedtuple</span><br><span class="line"></span><br><span class="line">BaseDir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">source = os.path.join(BaseDir,&apos;dir1/inventory/multinode&apos;)</span><br><span class="line">loader = DataLoader()   # 实例化loader对象</span><br><span class="line">myinven = InventoryManager(loader=loader,sources=[source,])   # 实例化inventory对象</span><br><span class="line">print(myinven.get_groups_dict())</span><br><span class="line"></span><br><span class="line">varmanager = VariableManager(loader=loader,inventory=myinven)  # 实例化VariableManager对象</span><br><span class="line"></span><br><span class="line">#^#Options 选项</span><br><span class="line">Options = namedtuple(&apos;Options&apos;,[</span><br><span class="line">                &apos;connection&apos;,&apos;module_path&apos;, &apos;forks&apos;, &apos;timeout&apos;,  &apos;remote_user&apos;,</span><br><span class="line">                &apos;ask_pass&apos;, &apos;private_key_file&apos;, &apos;ssh_common_args&apos;, &apos;ssh_extra_args&apos;, &apos;sftp_extra_args&apos;,</span><br><span class="line">                &apos;scp_extra_args&apos;, &apos;become&apos;, &apos;become_method&apos;, &apos;become_user&apos;, &apos;ask_value_pass&apos;, &apos;verbosity&apos;,</span><br><span class="line">                &apos;check&apos;, &apos;listhosts&apos;, &apos;listtasks&apos;, &apos;listtags&apos;, &apos;syntax&apos;,&apos;diff&apos;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">options = Options(connection=&apos;smart&apos;, module_path=None, forks=100, timeout=10,</span><br><span class="line">                remote_user=&apos;root&apos;, ask_pass=False, private_key_file=None, ssh_common_args=None, ssh_extra_args=None,</span><br><span class="line">                sftp_extra_args=None, scp_extra_args=None, become=None, become_method=None,</span><br><span class="line">                become_user=&apos;root&apos;, ask_value_pass=False, verbosity=None, check=False, listhosts=False,</span><br><span class="line">                listtasks=False, listtags=False, syntax=False, diff=True)</span><br><span class="line"></span><br><span class="line">#^# 执行对象和模块</span><br><span class="line">play_data = dict(</span><br><span class="line">    name=&quot;Ansible adhoc example&quot;,</span><br><span class="line">    hosts=&apos;192.168.1.6,&apos;,</span><br><span class="line">    gather_facts=&apos;no&apos;,</span><br><span class="line">    tasks=[</span><br><span class="line">        dict(action=dict(module=&apos;shell&apos;, args=&quot;touch /tmp/sss.txt&quot;)),</span><br><span class="line">        # dict(action=dict(module=&apos;debug&apos;, args=dict(msg=&quot;&#123;&#123;  shell_out.stdout  &#125;&#125;&quot;))),</span><br><span class="line">     ],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">play = Play().load(data=play_data,loader=loader,variable_manager=varmanager)</span><br><span class="line"></span><br><span class="line">#^# 重写CallbackBase父类</span><br><span class="line">class AdhocResultsCollector(CallbackBase):</span><br><span class="line">    def __init__(self, *args, **kwargs):</span><br><span class="line">        super(AdhocResultsCollector, self).__init__(*args, **kwargs)</span><br><span class="line">        self.host_ok = &#123;&#125;</span><br><span class="line">        self.host_unreachable = &#123;&#125;</span><br><span class="line">        self.host_failed = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_unreachable(self, result):</span><br><span class="line">        self.host_unreachable[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_ok(self, result,  *args, **kwargs):</span><br><span class="line">        self.host_ok[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_failed(self, result,  *args, **kwargs):</span><br><span class="line">        self.host_failed[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">callback = AdhocResultsCollector()</span><br><span class="line">passwords = dict()</span><br><span class="line">tqm = TaskQueueManager(inventory=myinven,</span><br><span class="line">                       variable_manager=varmanager,</span><br><span class="line">                       loader=loader,options=options,</span><br><span class="line">                       passwords=passwords,</span><br><span class="line">                       stdout_callback=callback</span><br><span class="line">                       )</span><br><span class="line"></span><br><span class="line">result_status_code = tqm.run(play)</span><br><span class="line"></span><br><span class="line">print(callback.host_ok.items())</span><br><span class="line"></span><br><span class="line">result_raw = dict(</span><br><span class="line">    success = &#123;&#125;,</span><br><span class="line">    failed = &#123;&#125;,</span><br><span class="line">    unreachable = &#123;&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">for host,result in  callback.host_ok.items():</span><br><span class="line">    result_raw[&apos;success&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.host_failed.items():</span><br><span class="line">    result_raw[&apos;failed&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.host_unreachable.items():</span><br><span class="line">    result_raw[&apos;unreachable&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">print(json.dumps(result_raw,indent=4))</span><br></pre></td></tr></table></figure></p>
<h3 id="1-2-playbook-callback重写"><a href="#1-2-playbook-callback重写" class="headerlink" title="1.2 playbook callback重写"></a>1.2 playbook callback重写</h3><p>写入示例playbook文件site.yml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: 192.168.1.6</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    touch_file: &quot;site.txt&quot;</span><br><span class="line">  tasks:</span><br><span class="line">    - name: touch file</span><br><span class="line">      shell: &quot;touch /tmp/&#123;&#123;  touch_file &#125;&#125;&quot;</span><br></pre></td></tr></table></figure></p>
<p>编写play_book.py 文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">import os,sys,json</span><br><span class="line">import ansible.constants as C</span><br><span class="line">from ansible.parsing.dataloader import  DataLoader</span><br><span class="line">from ansible.vars.manager import  VariableManager</span><br><span class="line">from ansible.inventory.manager import  InventoryManager</span><br><span class="line">from ansible.playbook import Play</span><br><span class="line">from ansible.executor.task_queue_manager import  TaskQueueManager</span><br><span class="line">from ansible.executor.playbook_executor import  PlaybookExecutor</span><br><span class="line">from ansible.plugins.callback import CallbackBase</span><br><span class="line">from ansible.inventory.host import  Host,Group</span><br><span class="line">from  collections import namedtuple</span><br><span class="line"></span><br><span class="line">BaseDir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">source = os.path.join(BaseDir,&apos;dir1/inventory/multinode&apos;)</span><br><span class="line">loader = DataLoader()   # 实例化loader对象</span><br><span class="line">myinven = InventoryManager(loader=loader,sources=[source,])   # 实例化inventory对象</span><br><span class="line">print(myinven.get_groups_dict())</span><br><span class="line"></span><br><span class="line">varmanager = VariableManager(loader=loader,inventory=myinven)  # 实例化VariableManager对象</span><br><span class="line"></span><br><span class="line"># Options 选项</span><br><span class="line">Options = namedtuple(&apos;Options&apos;,[</span><br><span class="line">                                &apos;connection&apos;,</span><br><span class="line">                                &apos;module_path&apos;,</span><br><span class="line">                                &apos;forks&apos;,</span><br><span class="line">                                &apos;timeout&apos;,</span><br><span class="line">                                &apos;remote_user&apos;,</span><br><span class="line">                                &apos;ask_pass&apos;,</span><br><span class="line">                                &apos;private_key_file&apos;,</span><br><span class="line">                                &apos;ssh_common_args&apos;,</span><br><span class="line">                                &apos;ssh_extra_args&apos;,</span><br><span class="line">                                &apos;sftp_extra_args&apos;,</span><br><span class="line">                                &apos;scp_extra_args&apos;,</span><br><span class="line">                                &apos;become&apos;,</span><br><span class="line">                                &apos;become_method&apos;,</span><br><span class="line">                                &apos;become_user&apos;,</span><br><span class="line">                                &apos;ask_value_pass&apos;,</span><br><span class="line">                                &apos;verbosity&apos;,</span><br><span class="line">                                &apos;check&apos;,</span><br><span class="line">                                &apos;listhosts&apos;,</span><br><span class="line">                                &apos;listtasks&apos;,</span><br><span class="line">                                &apos;listtags&apos;,</span><br><span class="line">                                &apos;syntax&apos;,</span><br><span class="line">                                &apos;diff&apos;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">options = Options(connection=&apos;smart&apos;,</span><br><span class="line">                  module_path=None,</span><br><span class="line">                  forks=100,</span><br><span class="line">                  timeout=10,</span><br><span class="line">                  remote_user=&apos;root&apos;,</span><br><span class="line">                  ask_pass=False,</span><br><span class="line">                  private_key_file=None,</span><br><span class="line">                  ssh_common_args=None,</span><br><span class="line">                  ssh_extra_args=None,</span><br><span class="line">                  sftp_extra_args=None,</span><br><span class="line">                  scp_extra_args=None,</span><br><span class="line">                  become=None,</span><br><span class="line">                  become_method=None,</span><br><span class="line">                  become_user=&apos;root&apos;,</span><br><span class="line">                  ask_value_pass=False,</span><br><span class="line">                  verbosity=None,</span><br><span class="line">                  check=False,</span><br><span class="line">                  listhosts=False,</span><br><span class="line">                  listtasks=False,</span><br><span class="line">                  listtags=False,</span><br><span class="line">                  syntax=False,</span><br><span class="line">                  diff=True,</span><br><span class="line">                  )</span><br><span class="line"></span><br><span class="line"># 重写CallbackBase父类</span><br><span class="line">class PlayBookResultsCollector(CallbackBase):</span><br><span class="line">    CALLBACK_VERSION = 2.0</span><br><span class="line">    def __init__(self, *args, **kwargs):</span><br><span class="line">        super(PlayBookResultsCollector, self).__init__(*args, **kwargs)</span><br><span class="line">        self.task_ok = &#123;&#125;</span><br><span class="line">        self.task_skipped = &#123;&#125;</span><br><span class="line">        self.task_failed = &#123;&#125;</span><br><span class="line">        self.task_status = &#123;&#125;</span><br><span class="line">        self.task_unreachable = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_ok(self, result, *args, **kwargs):</span><br><span class="line">        self.task_ok[result._host.get_name()]  = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_failed(self, result, *args, **kwargs):</span><br><span class="line">        self.task_failed[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_unreachable(self, result):</span><br><span class="line">        self.task_unreachable[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_skipped(self, result):</span><br><span class="line">        self.task_ok[result._host.get_name()]  = result</span><br><span class="line"></span><br><span class="line">    def v2_playbook_on_stats(self, stats):</span><br><span class="line">        hosts = sorted(stats.processed.keys())</span><br><span class="line">        for h in hosts:</span><br><span class="line">            t = stats.summarize(h)</span><br><span class="line">            self.task_status[h] = &#123;</span><br><span class="line">                                       &quot;ok&quot;:t[&apos;ok&apos;],</span><br><span class="line">                                       &quot;changed&quot; : t[&apos;changed&apos;],</span><br><span class="line">                                       &quot;unreachable&quot;:t[&apos;unreachable&apos;],</span><br><span class="line">                                       &quot;skipped&quot;:t[&apos;skipped&apos;],</span><br><span class="line">                                       &quot;failed&quot;:t[&apos;failures&apos;]</span><br><span class="line">                                   &#125;</span><br><span class="line"># 执行对象和模块</span><br><span class="line">passwords = &#123;&#125;</span><br><span class="line">#传入playbooks, inventory, variable_manager, loader, options, passwords</span><br><span class="line">playbook = PlaybookExecutor(playbooks=[&apos;site.yml&apos;,],</span><br><span class="line">                            inventory=myinven,</span><br><span class="line">                            variable_manager=varmanager,</span><br><span class="line">                            loader=loader,</span><br><span class="line">                            options=options,</span><br><span class="line">                            passwords=passwords</span><br><span class="line">                            )</span><br><span class="line"></span><br><span class="line"># 把重写的CallbackBase父类加载进playbook</span><br><span class="line">callback = PlayBookResultsCollector()</span><br><span class="line">playbook._tqm._stdout_callback = callback</span><br><span class="line">playbook.run()</span><br><span class="line"></span><br><span class="line">result_raw = dict(</span><br><span class="line">    success = &#123;&#125;,</span><br><span class="line">    failed = &#123;&#125;,</span><br><span class="line">    unreachable = &#123;&#125;,</span><br><span class="line">    skipped = &#123;&#125;,</span><br><span class="line">    status = &#123;&#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">for host,result in  callback.task_ok.items():</span><br><span class="line">    result_raw[&apos;success&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.task_failed.items():</span><br><span class="line">    result_raw[&apos;failed&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.task_unreachable.items():</span><br><span class="line">    result_raw[&apos;unreachable&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.task_skipped.items():</span><br><span class="line">    result_raw[&apos;skipped&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host, result in callback.task_status.items():</span><br><span class="line">    result_raw[&apos;status&apos;][host] = result</span><br><span class="line"></span><br><span class="line">print(json.dumps(result_raw,indent=4))</span><br></pre></td></tr></table></figure></p>
<p>执行示例<br>python3 play_book.py 返回类似如下结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;success&quot;: &#123;</span><br><span class="line">        &quot;192.168.1.6&quot;: &#123;</span><br><span class="line">            &quot;changed&quot;: true,</span><br><span class="line">            &quot;end&quot;: &quot;2019-01-14 04:50:06.190607&quot;,</span><br><span class="line">            &quot;stdout&quot;: &quot;&quot;,</span><br><span class="line">            &quot;cmd&quot;: &quot;touch /tmp/site.txt&quot;,</span><br><span class="line">            &quot;rc&quot;: 0,</span><br><span class="line">            &quot;start&quot;: &quot;2019-01-14 04:50:06.186466&quot;,</span><br><span class="line">            &quot;stderr&quot;: &quot;&quot;,</span><br><span class="line">            &quot;delta&quot;: &quot;0:00:00.004141&quot;,</span><br><span class="line">            &quot;invocation&quot;: &#123;</span><br><span class="line">                &quot;module_args&quot;: &#123;</span><br><span class="line">                    &quot;creates&quot;: null,</span><br><span class="line">                    &quot;executable&quot;: null,</span><br><span class="line">                    &quot;_uses_shell&quot;: true,</span><br><span class="line">                    ... 略</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;failed&quot;: &#123;&#125;,</span><br><span class="line">    &quot;unreachable&quot;: &#123;&#125;,</span><br><span class="line">    &quot;skipped&quot;: &#123;&#125;,</span><br><span class="line">    &quot;status&quot;: &#123;</span><br><span class="line">        &quot;192.168.1.6&quot;: &#123;</span><br><span class="line">            &quot;ok&quot;: 2,</span><br><span class="line">            &quot;changed&quot;: 1,</span><br><span class="line">            &quot;unreachable&quot;: 0,</span><br><span class="line">            &quot;skipped&quot;: 0,</span><br><span class="line">            &quot;failed&quot;: 0</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>adhoc重写方法如host_ok,host_failed,host_unreachable</li>
<li>playbook重写方法如task_ok,task_failed,task_unreachable,task_skipped,task_status,task_changed</li>
<li>返回如callback.task_ok.items(),其中键为host,值为result对象，result._result得到一个字典类型的详细结果</li>
</ul>
<p>&lt;&lt; 完结 &gt;&gt;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/01/12/ansible-Callback-02/" data-id="ckjsb7htx000i4kjxajx39fu3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-ansible-api-01" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/10/ansible-api-01/" class="article-date">
  <time datetime="2019-01-10T12:39:12.000Z" itemprop="datePublished">2019-01-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/ansible/">ansible</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/10/ansible-api-01/">python3下ansible api学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-1-ansible-api基础"><a href="#1-1-ansible-api基础" class="headerlink" title="1.1 ansible api基础"></a>1.1 ansible api基础</h3><p>环境说明：</p>
<ul>
<li>python version: python3</li>
<li>ansible version:  2.7.5</li>
<li>inventory file:  dir1/inventory/multinode</li>
</ul>
<p>清单文件定义：  dir1/inventory/multinode<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[control]</span><br><span class="line">192.168.1.6 var1=&quot;ssss&quot;  ansible_ssh_user=root ansible_ssh_pass=&apos;123&apos;</span><br><span class="line"></span><br><span class="line">[nova:children]</span><br><span class="line">control</span><br><span class="line"></span><br><span class="line">[cinder:children]</span><br><span class="line">control</span><br><span class="line"></span><br><span class="line">[glance:children]</span><br></pre></td></tr></table></figure></p>
<p>一个单一文件进行简单的接口学习:  dir1/f1.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line">import os,sys,json</span><br><span class="line">from ansible.parsing.dataloader import  DataLoader</span><br><span class="line">from ansible.vars.manager import   VariableManager</span><br><span class="line">from ansible.inventory.manager import InventoryManager</span><br><span class="line">from ansible.playbook  import play</span><br><span class="line">from ansible.executor.task_queue_manager import TaskQueueManager</span><br><span class="line">from ansible.plugins.callback import CallbackBase</span><br><span class="line">import ansible.constants as C</span><br><span class="line"></span><br><span class="line">BaseDir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">source = os.path.join(BaseDir,&quot;dir1/inventory/multinode&quot;)</span><br><span class="line">loader  = DataLoader()</span><br><span class="line">inven = InventoryManager(loader=loader,sources=[source,])</span><br><span class="line"># print(inven.get_hosts())</span><br><span class="line"></span><br><span class="line">inven.add_group(&apos;test_group2&apos;)</span><br><span class="line">print(inven.get_groups_dict())</span><br><span class="line">inven.add_host(host=&apos;192.168.1.7&apos;,port=22,group=&apos;test_group2&apos;)</span><br><span class="line">print(inven.get_groups_dict())</span><br><span class="line"></span><br><span class="line">host = inven.get_host(hostname=&apos;192.168.1.6&apos;)</span><br><span class="line"></span><br><span class="line">variableman = VariableManager(loader=loader,inventory=inven)</span><br><span class="line">vars = variableman.get_vars(host=host)</span><br><span class="line"></span><br><span class="line"># print(json.dumps(vars,indent=4))</span><br><span class="line">variableman.set_host_variable(host=host,varname=&apos;k1&apos;,value=&apos;v1&apos;)   # 局部的</span><br><span class="line"></span><br><span class="line">x = variableman.get_vars(host=host)</span><br><span class="line">print(x[&apos;k1&apos;])</span><br><span class="line">print(variableman.__dict__)</span><br><span class="line">variableman._extra_vars = &#123;&quot;k2&quot;: &quot;v2&quot;&#125;     # 添加全局变量</span><br><span class="line"></span><br><span class="line">x = variableman.get_vars()  # 不传host说明是全局的</span><br></pre></td></tr></table></figure></p>
<p>执行测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3  dir1/f1.py   # 输出调用信息对照接口就知道只些方法是干什么的了</span><br></pre></td></tr></table></figure></p>
<h3 id="1-2-adhoc模式示例学习"><a href="#1-2-adhoc模式示例学习" class="headerlink" title="1.2 adhoc模式示例学习"></a>1.2 adhoc模式示例学习</h3><p>编辑dir1/adhoc.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line">import os,sys,json</span><br><span class="line">import ansible.constants as C</span><br><span class="line">from ansible.parsing.dataloader import  DataLoader</span><br><span class="line">from ansible.vars.manager import  VariableManager</span><br><span class="line">from ansible.inventory.manager import  InventoryManager</span><br><span class="line">from ansible.playbook import Play</span><br><span class="line">from ansible.executor.task_queue_manager import  TaskQueueManager</span><br><span class="line">from ansible.executor.playbook_executor import  PlaybookExecutor</span><br><span class="line">from ansible.plugins.callback import CallbackBase</span><br><span class="line">from ansible.inventory.host import  Host,Group</span><br><span class="line">from  collections import namedtuple</span><br><span class="line"></span><br><span class="line">BaseDir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">source = os.path.join(BaseDir,&apos;dir1/inventory/multinode&apos;)</span><br><span class="line">loader = DataLoader()   # 实例化loader对象</span><br><span class="line">myinven = InventoryManager(loader=loader,sources=[source,])   # 实例化inventory对象</span><br><span class="line">print(myinven.get_groups_dict())</span><br><span class="line"></span><br><span class="line">varmanager = VariableManager(loader=loader,inventory=myinven)  # 实例化VariableManager对象</span><br><span class="line"></span><br><span class="line"># Options 选项</span><br><span class="line">Options = namedtuple(&apos;Options&apos;,[</span><br><span class="line">                &apos;connection&apos;,&apos;module_path&apos;, &apos;forks&apos;, &apos;timeout&apos;,  &apos;remote_user&apos;,</span><br><span class="line">                &apos;ask_pass&apos;, &apos;private_key_file&apos;, &apos;ssh_common_args&apos;, &apos;ssh_extra_args&apos;, &apos;sftp_extra_args&apos;,</span><br><span class="line">                &apos;scp_extra_args&apos;, &apos;become&apos;, &apos;become_method&apos;, &apos;become_user&apos;, &apos;ask_value_pass&apos;, &apos;verbosity&apos;,</span><br><span class="line">                &apos;check&apos;, &apos;listhosts&apos;, &apos;listtasks&apos;, &apos;listtags&apos;, &apos;syntax&apos;,&apos;diff&apos;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">options = Options(connection=&apos;smart&apos;, module_path=None, forks=100, timeout=10,</span><br><span class="line">                remote_user=&apos;root&apos;, ask_pass=False, private_key_file=None, ssh_common_args=None, ssh_extra_args=None,</span><br><span class="line">                sftp_extra_args=None, scp_extra_args=None, become=None, become_method=None,</span><br><span class="line">                become_user=&apos;root&apos;, ask_value_pass=False, verbosity=None, check=False, listhosts=False,</span><br><span class="line">                listtasks=False, listtags=False, syntax=False, diff=True)</span><br><span class="line"></span><br><span class="line"># 执行对象和模块</span><br><span class="line">play_data = dict(</span><br><span class="line">    name=&quot;Ansible adhoc example&quot;,</span><br><span class="line">    hosts=&apos;192.168.1.6,&apos;,</span><br><span class="line">    gather_facts=&apos;no&apos;,</span><br><span class="line">    tasks=[</span><br><span class="line">        dict(action=dict(module=&apos;shell&apos;, args=&quot;touch /tmp/sss.txt&quot;)),</span><br><span class="line">        # dict(action=dict(module=&apos;debug&apos;, args=dict(msg=&quot;&#123;&#123;  shell_out.stdout  &#125;&#125;&quot;))),</span><br><span class="line">     ],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">play = Play().load(data=play_data,loader=loader,variable_manager=varmanager)</span><br><span class="line">passwords = &#123;&#125;</span><br><span class="line">tqm = TaskQueueManager(inventory=myinven,variable_manager=varmanager, loader=loader,options=options,passwords=passwords)</span><br><span class="line"></span><br><span class="line">result = tqm.run(play)</span><br></pre></td></tr></table></figure></p>
<p>执行测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3  dir1/adhoc.py</span><br></pre></td></tr></table></figure></p>
<p>输出信息和命令行ansible直接模块运行一样，任务正常执行</p>
<h3 id="1-3-playbook-示例学习"><a href="#1-3-playbook-示例学习" class="headerlink" title="1.3 playbook 示例学习"></a>1.3 playbook 示例学习</h3><p>编辑dir1/play_book.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">import os,sys,json</span><br><span class="line">import ansible.constants as C</span><br><span class="line">from ansible.parsing.dataloader import  DataLoader</span><br><span class="line">from ansible.vars.manager import  VariableManager</span><br><span class="line">from ansible.inventory.manager import  InventoryManager</span><br><span class="line">from ansible.playbook import Play</span><br><span class="line">from ansible.executor.task_queue_manager import  TaskQueueManager</span><br><span class="line">from ansible.executor.playbook_executor import  PlaybookExecutor</span><br><span class="line">from ansible.plugins.callback import CallbackBase</span><br><span class="line">from ansible.inventory.host import  Host,Group</span><br><span class="line">from  collections import namedtuple</span><br><span class="line"></span><br><span class="line">BaseDir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">source = os.path.join(BaseDir,&apos;dir1/inventory/multinode&apos;)</span><br><span class="line">loader = DataLoader()   # 实例化loader对象</span><br><span class="line">myinven = InventoryManager(loader=loader,sources=[source,])   # 实例化inventory对象</span><br><span class="line">print(myinven.get_groups_dict())</span><br><span class="line"></span><br><span class="line">varmanager = VariableManager(loader=loader,inventory=myinven)  # 实例化VariableManager对象</span><br><span class="line"></span><br><span class="line"># Options 选项</span><br><span class="line">Options = namedtuple(&apos;Options&apos;,[</span><br><span class="line">                &apos;connection&apos;,&apos;module_path&apos;, &apos;forks&apos;, &apos;timeout&apos;,  &apos;remote_user&apos;,</span><br><span class="line">                &apos;ask_pass&apos;, &apos;private_key_file&apos;, &apos;ssh_common_args&apos;, &apos;ssh_extra_args&apos;, &apos;sftp_extra_args&apos;,</span><br><span class="line">                &apos;scp_extra_args&apos;, &apos;become&apos;, &apos;become_method&apos;, &apos;become_user&apos;, &apos;ask_value_pass&apos;, &apos;verbosity&apos;,</span><br><span class="line">                &apos;check&apos;, &apos;listhosts&apos;, &apos;listtasks&apos;, &apos;listtags&apos;, &apos;syntax&apos;,&apos;diff&apos;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">options = Options(connection=&apos;smart&apos;, module_path=None, forks=100, timeout=10,</span><br><span class="line">                remote_user=&apos;root&apos;, ask_pass=False, private_key_file=None, ssh_common_args=None, ssh_extra_args=None,</span><br><span class="line">                sftp_extra_args=None, scp_extra_args=None, become=None, become_method=None,</span><br><span class="line">                become_user=&apos;root&apos;, ask_value_pass=False, verbosity=None, check=False, listhosts=False,</span><br><span class="line">                listtasks=False, listtags=False, syntax=False, diff=True)</span><br><span class="line"></span><br><span class="line"># 执行对象和模块</span><br><span class="line">passwords = &#123;&#125;</span><br><span class="line">#传入playbooks, inventory, variable_manager, loader, options, passwords</span><br><span class="line">playbook = PlaybookExecutor(playbooks=[&apos;site.yml&apos;,],</span><br><span class="line">                            inventory=myinven,</span><br><span class="line">                            variable_manager=varmanager,</span><br><span class="line">                            loader=loader,</span><br><span class="line">                            options=options,</span><br><span class="line">                            passwords=passwords)</span><br><span class="line">playbook.run()</span><br></pre></td></tr></table></figure></p>
<p>用到的site.yml文件示例如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: 192.168.1.6</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    touch_file: &quot;site.txt&quot;</span><br><span class="line">  tasks:</span><br><span class="line">    - name: touch file</span><br><span class="line">      shell: &quot;touch /tmp/&#123;&#123;  touch_file &#125;&#125;&quot;</span><br></pre></td></tr></table></figure></p>
<p>执行测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 play_book.py</span><br></pre></td></tr></table></figure></p>
<p>输出信息和ansible-playbook命令行输出一样，任务正常执行</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/01/10/ansible-api-01/" data-id="ckjsb7htz000k4kjx6zxa2az6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-openvswitch" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/08/openvswitch/" class="article-date">
  <time datetime="2019-01-08T01:41:54.000Z" itemprop="datePublished">2019-01-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Openstack/">Openstack</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/08/openvswitch/">OpenVSwitch</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>交换机端口查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ovs-vsctl show</span><br><span class="line"># ovs-ofctl show</span><br><span class="line"># ovs-ofctl show br-int</span><br><span class="line"># ovs-ofctl show br-tun</span><br><span class="line"># virsh domiflist instance-00000017</span><br></pre></td></tr></table></figure></p>
<p>open flow流表查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ovs-ofctl dump-flows br-int</span><br><span class="line"># ovs-ofctl dump-flows br-tun</span><br><span class="line"></span><br><span class="line"># ip netns exec qrouter-c266eb04-0be8-448f-986f-6eef3a9bcdce ifconfig</span><br><span class="line"></span><br><span class="line"># dpkg-query -S /sbin/brctl</span><br><span class="line"># apt-get install bridge-utils</span><br><span class="line"># brctl show</span><br></pre></td></tr></table></figure></p>
<p>添加br-ex网桥：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># ovs-vsctl add-br br-ex</span><br><span class="line">桥加载到物理网口：</span><br><span class="line"># ovs-vsctl add-port br-ex eth0</span><br><span class="line">添加到不同vlan与端口模式</span><br><span class="line"># ovs-vsctl add-port br-ex eth1 tag=100            //设置为access端口</span><br><span class="line"># ovs-vsctl add-port br-ex eth2 trunk=200	   //设置为trunk端口,允许vlan200通过，默认允许所有vlan直接转发</span><br></pre></td></tr></table></figure></p>
<p>列出所有桥：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl list-br</span><br><span class="line">ovs-vsctl list-ports br-int</span><br><span class="line">ovs-vsctl  port-to-br  port_name</span><br></pre></td></tr></table></figure></p>
<p>列出桥上所接端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ovs-vsctl  list-ports br-ex</span><br><span class="line"># ovs-ofctl dump-ports br-ex</span><br><span class="line"># ovs-vsctl  list port</span><br></pre></td></tr></table></figure></p>
<p>根据交换机某个接口名称查端口号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ovs-vsctl list interface tap0_br | grep &quot;ofport &quot;</span><br><span class="line">ofport              : 1</span><br></pre></td></tr></table></figure></p>
<p>流表操作<br>注意： 流量匹配是有顺序的,table0–&gt;table1—&gt;table3–&gt;table4 –&gt;table5…<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># ovs-vsctl add-br vswitch0</span><br><span class="line"></span><br><span class="line">#发现有一条actions为NORMAL的流表项，这是默认存在的，用以实现交换机的基本动作</span><br><span class="line"># ovs-ofctl dump-flows vswitch0</span><br><span class="line">cookie=0x0, duration=267197.837s, table=0, n_packets=459, n_bytes=42190, idle_age=387, hard_age=65534, priority=0 actions=NORMAL</span><br><span class="line"></span><br><span class="line"># ovs-ofctl del-flows vswitch0   # 流表删除后所有流量将被丢弃</span><br><span class="line"># ovs-ofctl dump-flows vswitch0</span><br><span class="line"></span><br><span class="line"># 可以在table0添加类似规则使流量正常转发,没写表名默认table0</span><br><span class="line"># ovs-ofctl add-flow br-int &quot;priority=1,in_port=1,actions=output:4&quot;</span><br><span class="line"># ovs-ofctl add-flow br-int &quot;priority=2,in_port=4,actions=output:1&quot;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#flow优先级越高，会优先匹配,以下规则drop优先，流量被丢弃</span><br><span class="line"># ovs-ofctl del-flows br-int</span><br><span class="line"># ovs-ofctl add-flow br-int &quot;priority=1,in_port=1,actions=output:4&quot;</span><br><span class="line"># ovs-ofctl add-flow br-int &quot;priority=2,in_port=4,actions=output:1&quot;</span><br><span class="line"># ovs-ofctl add-flow vswitch0 &quot;priority=3,in_port=1,actions=drop&quot;</span><br></pre></td></tr></table></figure>
<p>将table0的规则添加到table1上，发出流量也是不通的，因为流表是有顺序的，table0没有匹配到，流量被丢弃<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># ovs-ofctl del-flows vswitch0</span><br><span class="line"># ovs-ofctl add-flow vswitch0 &quot;table=1,priority=1,in_port=1,actions=output:4&quot;</span><br><span class="line"># ovs-ofctl add-flow vswitch0 &quot;table=1,priority=2,in_port=4,actions=output:1&quot;</span><br><span class="line"># ovs-ofctl dump-flows vswitch0</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=3.485s, table=1, n_packets=0, n_bytes=0, idle_age=3, priority=1,in_port=1 actions=output:4</span><br><span class="line"> cookie=0x0, duration=3.033s, table=1, n_packets=0, n_bytes=0, idle_age=3, priority=2,in_port=4 actions=output:1</span><br></pre></td></tr></table></figure></p>
<p>现在给table0加上一条将数据包发送到table1处理的flow,  发现流量正常，这就明白了多个table之间是如何协调工作的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ovs-ofctl add-flow vswitch0 &quot;table=0,actions=goto_table=1&quot;</span><br></pre></td></tr></table></figure></p>
<p>组表操作<br>添加一个组表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ovs-ofctl -O OpenFlow13 add-group vswitch0 &quot;group_id=1,type=select,bucket=resubmit(,1)&quot;</span><br></pre></td></tr></table></figure></p>
<p>查看组表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ovs-ofctl -O OpenFlow13 dump-groups vswitch0</span><br></pre></td></tr></table></figure></p>
<p>在table0中增加两条flow，目的是将数据包发送到group table1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ovs-ofctl -O OpenFlow13 add-flow vswitch0 &quot;table=0,in_port=1,actions=group:1&quot;</span><br><span class="line"># ovs-ofctl -O OpenFlow13 add-flow vswitch0 &quot;table=0,in_port=4,actions=group:1&quot;</span><br></pre></td></tr></table></figure></p>
<p>向table1中增加两条flow，真正的数据转发在table1中进行,流量也正常通过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ovs-ofctl add-flow vswitch0 &quot;table=1,priority=1,in_port=1,actions=output:4&quot;</span><br><span class="line"># ovs-ofctl add-flow vswitch0 &quot;table=1,priority=2,in_port=4,actions=output:1&quot;</span><br></pre></td></tr></table></figure></p>
<h3 id="虚机挂在网桥上"><a href="#虚机挂在网桥上" class="headerlink" title="虚机挂在网桥上"></a>虚机挂在网桥上</h3><p>xml格式定义openvswitch网桥，以便于virt-install –network参数指定网桥启动虚机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># ovsbr0.xml</span><br><span class="line">&lt;network&gt;</span><br><span class="line">  &lt;name&gt;ovsbr0&lt;/name&gt;</span><br><span class="line">  &lt;forward mode=&apos;bridge&apos;/&gt;</span><br><span class="line">  &lt;bridge name=&apos;ovsbr0&apos;/&gt;</span><br><span class="line">  &lt;virtualport type=&apos;openvswitch&apos;/&gt;</span><br><span class="line">&lt;/network&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">virsh net-define ovsbr0.xml</span><br><span class="line">virsh net-start ovsbr0</span><br><span class="line">virsh net-autostart ovsbr0</span><br></pre></td></tr></table></figure>
<p>在安装kvm虚拟机时使用ovsbr0<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">virt-install \</span><br><span class="line">    -n vm-name \</span><br><span class="line">    -r 4096  \</span><br><span class="line">    --disk path=/data/kvm/rhel75-vm1.qcow2,format=qcow2,size=60 \</span><br><span class="line">    --vcpus 4  \</span><br><span class="line">    --noautoconsole \</span><br><span class="line">    --cdrom=/data/kvm/iso/rhel75-x86_64.iso \</span><br><span class="line">    --os-type=linux  \</span><br><span class="line">    --network network:ovsbr0 \</span><br><span class="line">    --vnc --vnclisten=0.0.0.0 --vncport=5901</span><br></pre></td></tr></table></figure></p>
<p>也可以将正在运行的KVM虚拟机的vnet网络接口强制接到ovs网桥上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#virsh dumpxml $vmname|grep vnet 查看某虚拟机在宿主机上对应的网络接口</span><br><span class="line">add-port ovsbr0 vnetxx</span><br></pre></td></tr></table></figure></p>
<p>网桥接口划vlan并配IP命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl add-port ovsbr0 tag10 tag=10 -- set interface tag10 type=internal</span><br><span class="line">ifconfig tag10 192.168.10.10/24 up</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ip link命令设置vlan接口命令</span><br><span class="line">ip link add link eth0 name eth0.10 type vlan id 10</span><br><span class="line">ifconfig eth0.10 192.168.10.33 netmask 255.255.255.0 broadcast 192.168.10.255 up</span><br><span class="line">route add default gw 192.168.10.1 dev eth0.10</span><br></pre></td></tr></table></figure>
<p>总结：这里只是命令总结，并没有什么实验逻辑</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/01/08/openvswitch/" data-id="ckjsb7hw300314kjxb8mymrez" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/3/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Ceph/">Ceph</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Openstack/">Openstack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Shell/">Shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebDjango开发/">WebDjango开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebFlask开发/">WebFlask开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebSocket/">WebSocket</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web爬虫开发/">Web爬虫开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ansible/">ansible</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/声明/">声明</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器世界/">容器世界</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/09/kubernetes-configmap/">kubernetes configmap</a>
          </li>
        
          <li>
            <a href="/2021/01/08/kubernetes-volumes/">kubernetes volumes</a>
          </li>
        
          <li>
            <a href="/2021/01/05/Kubernetes-ubuntu20.04/">Ubuntu20.04 Run k8s</a>
          </li>
        
          <li>
            <a href="/2020/07/10/mariadb-cluster-recovery/">mariadb cluster recovery</a>
          </li>
        
          <li>
            <a href="/2020/03/14/openstack-HA/">openstack-HA</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 wxq<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<!--
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
-->

<script src="https://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>