<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Welcome to wxq&#39;s Blog created in 2017-01-01</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Welcome to wxq&#39;s Blog created in 2017-01-01">
<meta property="og:url" content="http://www.digmyth.com/index.html">
<meta property="og:site_name" content="Welcome to wxq&#39;s Blog created in 2017-01-01">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Welcome to wxq&#39;s Blog created in 2017-01-01">
  
    <link rel="alternate" href="/atom.xml" title="Welcome to wxq&#39;s Blog created in 2017-01-01" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Welcome to wxq&#39;s Blog created in 2017-01-01</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.digmyth.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-linux-pacemaker-corosync" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/15/linux-pacemaker-corosync/" class="article-date">
  <time datetime="2020-02-15T01:42:54.000Z" itemprop="datePublished">2020-02-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/15/linux-pacemaker-corosync/">代理ARP学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="第一章-前言"><a href="#第一章-前言" class="headerlink" title="第一章 前言"></a>第一章 前言</h3><p>1.1 适用范围<br>本文档用于内部测试和交流学习，未经测试不得用于生产环境.</p>
<h3 id="第二章-相关概念"><a href="#第二章-相关概念" class="headerlink" title="第二章 相关概念"></a>第二章 相关概念</h3><h4 id="2-1-总体架构"><a href="#2-1-总体架构" class="headerlink" title="2.1 总体架构"></a>2.1 总体架构</h4><ul>
<li><p>Message Layer: 处在最底层的是消息层，用于传递集群心跳信息和集群事务信息.</p>
</li>
<li><p>API层:  所有软件要实现HA架构，开发应用软件时就必须调用API层实现资源管理和下层消息传递的交互，似乎所有软件没有调用这个API啊，是因为把这个步骤做成了通用架构，即CRM</p>
</li>
<li><p>Cluster Resource Manger: CRM 集群资源管理，实现资源调度完成高可用.</p>
</li>
<li><p>Local Resource Manger: LRM本地资源管理，CRM调用LRM完成本机或本地资源管理</p>
</li>
<li><p>Resource Agent: RA资源代理，其实就是管理服务的脚本，LRM调用RA完成资源管理(启动、停止、监视、迁移).</p>
</li>
</ul>
<p>详细来说：</p>
<p>Messaging and Infrastructure Layer<br>The primary or first layer is the messaging/infrastructure layer, also known as the Corosync layer. This layer contains components that send out the messages containing I am alive signals, as well as other information.</p>
<p>Resource Allocation Layer<br>The next layer is the resource allocation layer. This layer is the most complex, and consists of the following components</p>
<p>Cluster Resource Manager (CRM)<br>Every action taken in the resource allocation layer passes through the Cluster Resource Manager. If other components of the resource allocation layer (or components which are in a higher layer) need to communicate, they do so through the local CRM. On every node, the CRM maintains the Cluster Information Base (CIB).</p>
<p>Cluster Information Base (CIB)<br>The Cluster Information Base is an in-memory XML representation of the entire cluster configuration and current status. It contains definitions of all cluster options, nodes, resources, constraints and the relationship to each other. The CIB also synchronizes updates to all cluster nodes. There is one master CIB in the cluster, maintained by the Designated Coordinator (DC). All other nodes contain a CIB replica</p>
<p>Designated Coordinator (DC)<br>One CRM in the cluster is elected as DC. The DC is the only entity in the cluster that can decide that a cluster-wide change needs to be performed, such as fencing a node or moving resources around. The DC is also the node where the master copy of the CIB is kept. All other nodes get their configuration and resource allocation information from the current DC. The DC is elected from all nodes in the cluster after a membership change</p>
<p>Policy Engine (PE)<br>Whenever the Designated Coordinator needs to make a cluster-wide change (react to a new CIB), the Policy Engine calculates the next state of the cluster based on the current state and configuration. The PE also produces a transition graph containing a list of (resource) actions and dependencies to achieve the next cluster state. The PE always runs on the DC</p>
<p>Local Resource Manager (LRM)<br>The LRM calls the local Resource Agents (see Resource Layer) on behalf of the CRM. It can thus perform start / stop / monitor operations and report the result to the CRM. The LRM is the authoritative source for all resource-related information on its local node.</p>
<p>Resource Layer<br>The highest layer is the Resource Layer. The Resource Layer includes one or more Resource Agents (RA). Resource Agents are programs (usually shell scripts) that have been written to start, stop, and monitor a certain kind of service (a resource). Resource Agents are called only by the LRM. Third parties can include their own agents in a defined location in the file system and thus provide out-of-the-box cluster integration for their own software.</p>
<p>Process Flow<br>SUSE Linux Enterprise High Availability Extension uses Pacemaker as CRM. The CRM is implemented as daemon (crmd) that has an instance on each cluster node. Pacemaker centralizes all cluster decision-making by electing one of the crmd instances to act as a master. Should the elected crmd process (or the node it is on) fail, a new one is established.<br>A CIB, reflecting the cluster’s configuration and current state of all resources in the cluster is kept on each node. The contents of the CIB are automatically kept synchronous across the entire cluster.<br>Many actions performed in the cluster will cause a cluster-wide change. These actions can include things like adding or removing a cluster resource or changing resource constraints. It is important to understand what happens in the cluster when you perform such an action.<br>For example, suppose you want to add a cluster IP address resource. To do this, you can use one of the command line tools or the Web interface to modify the CIB. It is not required to perform the actions on the DC, you can use either tool on any node in the cluster and they will be relayed to the DC. The DC will then replicate the CIB change to all cluster nodes.<br>Based on the information in the CIB, the PE then computes the ideal state of the cluster and how it should be achieved and feeds a list of instructions to the DC. The DC sends commands via the messaging/infrastructure layer which are received by the crmd peers on other nodes. Each crmd uses its LRM (implemented as lrmd) to perform resource modifications. The lrmd is not cluster-aware and interacts directly with resource agents (scripts).<br>All peer nodes report the results of their operations back to the DC. After the DC concludes that all necessary operations are successfully performed in the cluster, the cluster will go back to the idle state and wait for further events. If any operation was not carried out as planned, the PE is invoked again with the new information recorded in the CIB.<br>In some cases, it may be necessary to power off nodes to protect shared data or complete resource recovery. For this Pacemaker comes with a fencing subsystem, stonithd. STONITH is an acronym for Shoot The Other Node In The Head. It is usually implemented with a STONITH shared block device, remote management boards, or remote power switches. In Pacemaker, STONITH devices are modeled as resources (and configured in the CIB) to enable them to be easily used. However, stonithd takes care of understanding the STONITH topology such that its clients request a node be fenced and it does the rest.<br>什么意思？</p>
<p>就是说corosync工作在消息层，用于心跳消息传递和集群事务信息传递.向上供集群资源管理CRM调用，再上层是本地资源管理调用Resource Agent完成资源管理。</p>
<p>在一个集群中只有一个节点为指定协调员(DC: Designated Coordinator), 用于收集整个集群信息供Policy Engine做出事务决策，哪个资源该关闭，哪个资源该迁移，发生脑裂时哪个节点该自裁suicite或shoot the head爆头.</p>
<p>CIB: Cluster information Base为集群信息库，保存整个集群信息，由主节点统一下发CIB集群息，配置时commit也是一个下发同步过程，副节点只保存CIB副本</p>
<p>Heartbeat信息传递：<br>Unicast单播 –&gt;基于udpu<br>Multicast多播  –&gt;基于udp<br>Broadcase广播</p>
<h4 id="2-2-corosync"><a href="#2-2-corosync" class="headerlink" title="2.2 corosync"></a>2.2 corosync</h4><p>消息层除了corosync还有哪些？<br>Heartbeat v1: 不仅有消息层，还自带haresource资源管理层.<br>Heartbeat v2: 不仅有消息层，还自带名为CRM的资源管理层.<br>Heartbeat v3: 只有消息层，资源管理层己经独立为pacemaker.<br>Corosync v2: 拥有良好的vote system投票系统<br>Cman： Redhat研发，自带投票系统.</p>
<p>2.3 pacemaker<br>Pacemaker工作在资源管理层，除了pacemaker还有哪些可以作为资源管理?</p>
<p>Heartbeat v1的haresource.<br>Heartbeat v2的CRM<br>Rgmanager: Redhat研发</p>
<p>2.4 集群组合<br>○1Heartbeat v1自带完整消息层和资源管理.<br>○2Heartbeat v2自带完整消息层和资源管理.<br>○3Heartbeat v3 + 独立出来的pacemaker.<br>○4corosync v2 + pacemaker完美组合.<br>○5cman + rgmanager 其实就是红帽的RHCS集群套件.<br>○6cman+corosync v1 + pacemaker: cman作为 corosync的插件，工作为corosync v1版本的投票系统，因为cman拥有良好投票系统而corosync v1没有投票系统，再结合pacemaker一同工作.</p>
<p>结论： corosync v2 + pacemaker完美组合.</p>
<h3 id="第三章-集群安装"><a href="#第三章-集群安装" class="headerlink" title="第三章 集群安装"></a>第三章 集群安装</h3><p>3.1 提前条件<br>1 关闭Selinux<br>2 同步时间<br>3 主机名或DNS解析<br>4 关闭防火墙 systemctl stop firewalld</p>
<p>3.2 集群安装<br>集群安装：</p>
<p>所有节点软件安装pcs，pcs客户端工具可以完成集群全生命周期管理，包括集群软件自动安装，初始化、配置和删除.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# yum install pcs  resource-agents</span><br><span class="line">corosync  pacemaker   policycoreutils # 自动依赖软件</span><br><span class="line">[root@node1 ~]# systemctl  enable pcsd</span><br><span class="line">[root@node1 ~]# systemctl  start  pcsd</span><br><span class="line">[root@node1 ~]# pcs cluster -h    查看帮助</span><br></pre></td></tr></table></figure></p>
<p>集群认证：<br>自动生成集群用户hacluster,这里需要设置hacluster密码用于初始化集群认证<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# echo &quot;hacluster:hacluster&quot; | chpasswd</span><br><span class="line">[root@node1 ~]# pcs cluster auth node1 node2 -h hacluster -p hacluster</span><br></pre></td></tr></table></figure></p>
<p>集群初始化：<br>初始化完成后自动生成/etc/corosync/corosync.conf配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]#pcs cluster setup --name mycluster node1 node2</span><br></pre></td></tr></table></figure></p>
<p>启动集群：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# pcs cluster start -all</span><br><span class="line">[root@node1 ~]# pcs status</span><br></pre></td></tr></table></figure>
<p>集群验证：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# corosync-cfgtool  -s</span><br><span class="line">Printing ring status.</span><br><span class="line">Local node ID 1</span><br><span class="line">RING ID 0</span><br><span class="line">	id	= 192.168.1.39</span><br><span class="line">	status	= ring 0 active with no faults</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# corosync-cmapctl  | grep member</span><br><span class="line">runtime.totem.pg.mrp.srp.members.1.config_version (u64) = 0</span><br><span class="line">runtime.totem.pg.mrp.srp.members.1.ip (str) = r(0) ip(192.168.1.39) </span><br><span class="line">runtime.totem.pg.mrp.srp.members.1.join_count (u32) = 1</span><br><span class="line">runtime.totem.pg.mrp.srp.members.1.status (str) = joined</span><br><span class="line">runtime.totem.pg.mrp.srp.members.2.config_version (u64) = 0</span><br><span class="line">runtime.totem.pg.mrp.srp.members.2.ip (str) = r(0) ip(192.168.1.40) </span><br><span class="line">runtime.totem.pg.mrp.srp.members.2.join_count (u32) = 1</span><br><span class="line">runtime.totem.pg.mrp.srp.members.2.status (str) = joined</span><br></pre></td></tr></table></figure>
<h3 id="第四章-集群配置"><a href="#第四章-集群配置" class="headerlink" title="第四章 集群配置"></a>第四章 集群配置</h3><p>4.1 管理工具<br>客户端工具除了红帽研发自带的pcs ,还有suse研发的crmsh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# cd /etc/yum.repos.d/</span><br><span class="line"># wget http://download.opensuse.org/repositories/network:/ha-clustering:/Stable/CentOS_CentOS-7/network:ha-clustering:Stable.repo</span><br><span class="line"># yum install crmsh pssh</span><br></pre></td></tr></table></figure>
<p>4.2 集群配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># pcs  property list --all</span><br><span class="line"># pcs  property  set stonith-enabled=false</span><br><span class="line"># crm_verify  -L -V</span><br><span class="line">#crm configur verify</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">eg:</span><br><span class="line"># yum install httpd</span><br><span class="line"># systemctl start httpd</span><br><span class="line"># systemctl enable httpd</span><br><span class="line"># crm configure primitive webip ocf:heartbeat:IPaddr params ip=192.168.1.99</span><br><span class="line"># crm configure primitive webserver systemd:httpd</span><br><span class="line"># crm configure group web_group webip webserver</span><br><span class="line">#crm configur verify</span><br><span class="line">#crm configur commit</span><br></pre></td></tr></table></figure>
<p>Study crmsh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">configure#</span><br><span class="line">primitive webip ocf:heartbeat:IPaddr2 params ip=&quot;172.16.100.92&quot; op monitor interval=30s timeout=20s</span><br><span class="line">primitive webserver systemd:httpd op monitor interval=20s timeout=20s</span><br><span class="line">primitive webstore ocf:heartbeat:Filesystem params device=&quot;172.16.100.6:/www/htdocs&quot; directory=&quot;/var/www/html&quot; fstype=&quot;nfs&quot; op start timeout=60s op stop timeout=60s op monitor interval=20s timeout=40s</span><br><span class="line"># 排列约束(定义资源必须在一起或必须不能在一起)</span><br><span class="line">colocation webserver_with_webstore_and_webip inf: webserver ( webip webstore )</span><br><span class="line">order webstore_after_webip Mandatory: web webstore</span><br><span class="line">show xml</span><br><span class="line">order webserver_after_webstore Mandatory: webstore webserver</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">####pcs study ....</span><br><span class="line">pcs resource create webip ocf:heartbeat:IPaddr ip=&quot;172.16.100.93&quot; op monitor interval=20s timeout=10s</span><br><span class="line">pcs resource create webstore ocf:heartbeat:Filesystem device=&quot;172.16.100.6:/www/htdocs&quot; directory=&quot;/var/www/html&quot; fstype=&quot;nfs&quot; op start timeout=60s op stop timeout=60s op monitor interval=20s timeout=40s</span><br><span class="line">pcs resourece create webserver systemd:httpd op monitor interval=30s timeout=20s</span><br><span class="line">pcs status</span><br><span class="line"></span><br><span class="line">pcs resource group add webservice webip webstore webserver</span><br><span class="line"></span><br><span class="line">crm configure property stonith-enabled=false</span><br><span class="line">crm configure property no-quorum-policy=ignore</span><br><span class="line">crm configure show</span><br></pre></td></tr></table></figure>
<p>4.3 资源类别与属性</p>
<p>资源类别<br>○1primitive: 主资源，集群中或全局唯一资源<br>○2clone: 克隆资源，允许在集群中多份存在<br>○3multi-state:多状态资源（master/slave）<br>○4group: 组资源，多个资源归为一组便于统一调度，统一启停，统一监视，统一相关性设置</p>
<p>资源属性<br>○1Priority: 优先级.<br>○2target-role: 目标角色，资源在节点上默认所处状态started/stopped/master.<br>○3is-managed: 可被管理.<br>○4resource-stickiness: 资源粘性.定义资源对当前节点的粘性</p>
<p>资源约束<br>位置约束： location  constraint,资源对某点的倾向性.<br>排列约束： colocation contraint,定义多个资源必须在一起或必须不能在一起.<br>顺序约束： order constraint,定义多个资源启动时的先后顺序.</p>
<p>例：<br>比如B节点上有3个资源排列约束后必须在一起，并设置了每个资源的粘性值为50，总值为150，对A点节设置location  constraint倾向值为100，150&gt;100,完好的运行于B节点，如果B节点挂了，资源将迁移至A节点，那么A节点的值为150+100，没有比这个值大的节点存在时，资源将永久运行于A节点.</p>
<p>第五章 参考文献<br>5.1 附录<br>参考命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# crm configure show</span><br><span class="line">node 1: node1</span><br><span class="line">node 2: node2</span><br><span class="line">property cib-bootstrap-options: \</span><br><span class="line">	have-watchdog=false \</span><br><span class="line">	dc-version=1.1.20-5.el7_7.2-3c4c782f70 \</span><br><span class="line">	cluster-infrastructure=corosync \</span><br><span class="line">	cluster-name=mycluster \</span><br><span class="line">	stonith-enabled=false \</span><br><span class="line">	cluster-recheck-interval=5min \</span><br><span class="line">	pe-warn-series-max=1000 \</span><br><span class="line">	pe-error-series-max=1000 \</span><br><span class="line">	pe-input-series-max=1000</span><br><span class="line"></span><br><span class="line">列出资源类别，称为class</span><br><span class="line">[root@node1 ~]#	pcs resource standards</span><br><span class="line">[root@node1 ~]# crm ra</span><br><span class="line">crm(live)ra# classes    # 列出资源类别，heartbeat openstack pacemaker分别为资源提供者(provider)</span><br><span class="line">lsb</span><br><span class="line">ocf / .isolation heartbeat openstack pacemaker</span><br><span class="line">service</span><br><span class="line">systemd</span><br><span class="line">crm(live)ra# list systemd  # 列出每个类别下各个资源,称为type</span><br><span class="line">crm(live)ra# list ocf heartbeat # 类别下heartbeat提供者下的各个资源,称为type</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">crm(live)ra# info  systemd:httpd # 查看每个特定type使用时参数用法</span><br><span class="line">systemd unit file for httpd (systemd:httpd)</span><br><span class="line">The Apache HTTP Server</span><br><span class="line">Operations&apos; defaults (advisory minimum):</span><br><span class="line"></span><br><span class="line">    start         timeout=100</span><br><span class="line">    stop          timeout=100</span><br><span class="line">    status        timeout=100</span><br><span class="line">    monitor       timeout=100 interval=60</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">crm(live)ra# info ocf:heartbeat:Filesystem  # 查看每个特定type使用时参数用法，device、directory、fstype必需给</span><br><span class="line">Parameters (*: required, []: default):</span><br><span class="line">device* (string): block device</span><br><span class="line">    The name of block device for the filesystem, or -U, -L options for mount, or NFS mount specification.</span><br><span class="line">directory* (string): mount point</span><br><span class="line">    The mount point for the filesystem.</span><br><span class="line">fstype* (string): filesystem type</span><br><span class="line">    The type of filesystem to be mounted.</span><br><span class="line">	</span><br><span class="line">以ocf:heartbeat:Filesystem为例，那么就有了如下params 使用参数</span><br><span class="line">primitive webstore ocf:heartbeat:Filesystem params device=&quot;172.16.100.6:/www/htdocs&quot;  \</span><br><span class="line">directory=&quot;/var/www/html&quot; fstype=&quot;nfs&quot; op start timeout=60s op stop timeout=60s \</span><br><span class="line">op monitor interval=20s timeout=40s</span><br><span class="line">	</span><br><span class="line">[root@node1 ~]# crm configure</span><br><span class="line">crm(live)configure# help primitive  # 主资源配置帮助</span><br><span class="line">	Example:</span><br><span class="line">primitive apcfence stonith:apcsmart \</span><br><span class="line">  params ttydev=/dev/ttyS0 hostlist=&quot;node1 node2&quot; \</span><br><span class="line">  op start timeout=60s \</span><br><span class="line">  op monitor interval=30m timeout=60s</span><br><span class="line"></span><br><span class="line">primitive www8 apache \</span><br><span class="line">  configfile=/etc/apache/www8.conf \</span><br><span class="line">  operations $id-ref=apache_ops</span><br><span class="line">  </span><br><span class="line">pcs resource list</span><br><span class="line">pcs resource  list ocf</span><br><span class="line">  </span><br><span class="line">组资源可以使多个资源集中分布在一个节点上，排列约束也可以使一些资源绑定在一起</span><br></pre></td></tr></table></figure></p>
<p>添加一个常识<br>组播地址： 用于标识一个IP组播域：IANA把D类地址留给组播使用。<br>范围 ：224.0.0.0-239.255.255.255<br>永久组播地址：224.0.0.0-224.0.0.255<br>临时组播地址：224.0.1.0-238.255.255.255<br>本地组播地址：239.0.0.0-239.255.255.255<br>一般选用临时组播地址即可</p>
<p>5.2 参考文献<br>[1]clusterlabs官方文档：<a href="https://clusterlabs.org/quickstart-redhat.html" target="_blank" rel="noopener">https://clusterlabs.org/quickstart-redhat.html</a> </p>
<p>[2] SUSE enterprise server官方明细文档<br><a href="https://www.suse.com/documentation/sle-ha-12/book_sleha/data/sec_ha_architecture.html" target="_blank" rel="noopener">https://www.suse.com/documentation/sle-ha-12/book_sleha/data/sec_ha_architecture.html</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2020/02/15/linux-pacemaker-corosync/" data-id="ck8bu1tg4001o1ojxfvqif4lf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-ingress-nginx" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/20/ingress-nginx/" class="article-date">
  <time datetime="2020-01-20T12:51:41.000Z" itemprop="datePublished">2020-01-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器世界/">容器世界</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/20/ingress-nginx/">ingress-nginx</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        The article has been encrypted, please enter your password to view.<br>
        
          <p class="article-more-link">
            <a href="/2020/01/20/ingress-nginx/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2020/01/20/ingress-nginx/" data-id="ck8bu1tft00141ojxusaxrtup" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-openvswit_vlan流表" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/01/openvswit_vlan流表/" class="article-date">
  <time datetime="2020-01-01T01:41:54.000Z" itemprop="datePublished">2020-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Openstack/">Openstack</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/01/openvswit_vlan流表/">openvswit_vlan流表</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> 如果计算节点关闭防火墙，配置文件如下，那么就不会产生bridge桥及相应iptables规则<br> ml2部份配置文件如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[securitygroup]</span><br><span class="line">#enable_security_group = True</span><br><span class="line">#firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</span><br></pre></td></tr></table></figure></p>
<p>linuxBridge桥接口就会为空<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kvm-app-6:~ # brctl show  # 为空</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br></pre></td></tr></table></figure></p>
<p>查看某虚机接口信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kvm-app-6:~ # virsh  list</span><br><span class="line"> Id    Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line"> 1     instance-00000793              running</span><br><span class="line"></span><br><span class="line">kvm-app-6:~ # virsh domiflist instance-00000793</span><br><span class="line">Interface  Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">tap790c394d-70 bridge     br-int     virtio      fa:16:3e:1f:11:99</span><br></pre></td></tr></table></figure></p>
<p>ovs-vsctl show<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">kvm-app-6:~ # ovs-vsctl show</span><br><span class="line">8ba4a76e-8c27-4807-a65a-f05b22a3ef76</span><br><span class="line">    Manager &quot;ptcp:6640:127.0.0.1&quot;</span><br><span class="line">        is_connected: true</span><br><span class="line">    Bridge br-int</span><br><span class="line">        Controller &quot;tcp:127.0.0.1:6633&quot;</span><br><span class="line">            is_connected: true</span><br><span class="line">        fail_mode: secure</span><br><span class="line">        Port int-br-ex</span><br><span class="line">            Interface int-br-ex</span><br><span class="line">                type: patch</span><br><span class="line">                options: &#123;peer=phy-br-ex&#125;</span><br><span class="line">        Port &quot;tap790c394d-70&quot;</span><br><span class="line">            tag: 1</span><br><span class="line">            Interface &quot;tap790c394d-70&quot;</span><br><span class="line">        Port br-int</span><br><span class="line">            Interface br-int</span><br><span class="line">                type: internal</span><br><span class="line">    Bridge br-ex</span><br><span class="line">        Controller &quot;tcp:127.0.0.1:6633&quot;</span><br><span class="line">            is_connected: true</span><br><span class="line">        fail_mode: secure</span><br><span class="line">        Port phy-br-ex</span><br><span class="line">            Interface phy-br-ex</span><br><span class="line">                type: patch</span><br><span class="line">                options: &#123;peer=int-br-ex&#125;</span><br><span class="line">        Port br-ex</span><br><span class="line">            Interface br-ex</span><br><span class="line">                type: internal</span><br><span class="line">        Port &quot;bond0&quot;</span><br><span class="line">            Interface &quot;bond0&quot;</span><br><span class="line">    ovs_version: &quot;2.7.6&quot;</span><br></pre></td></tr></table></figure></p>
<p>查看br-int桥接口信息ovs-ofctl  show br-int<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kvm-app-6:~ # ovs-ofctl  show br-int</span><br><span class="line">OFPT_FEATURES_REPLY (xid=0x2): dpid:00002a77dbc2860a</span><br><span class="line">n_tables:254, n_buffers:0</span><br><span class="line">capabilities: FLOW_STATS TABLE_STATS PORT_STATS QUEUE_STATS ARP_MATCH_IP</span><br><span class="line">actions: output enqueue set_vlan_vid set_vlan_pcp strip_vlan mod_dl_src mod_dl_dst mod_nw_src mod_nw_dst mod_nw_tos mod_tp_src mod_tp_dst</span><br><span class="line"> 1(int-br-ex): addr:3e:38:8a:6e:c1:de</span><br><span class="line">     config:     0</span><br><span class="line">     state:      0</span><br><span class="line">     speed: 0 Mbps now, 0 Mbps max</span><br><span class="line"> 2(tap790c394d-70): addr:fe:16:3e:1f:11:99</span><br><span class="line">     config:     0</span><br><span class="line">     state:      0</span><br><span class="line">     current:    10MB-FD COPPER</span><br><span class="line">     speed: 10 Mbps now, 0 Mbps max</span><br><span class="line"> LOCAL(br-int): addr:2a:77:db:c2:86:0a</span><br><span class="line">     config:     PORT_DOWN</span><br><span class="line">     state:      LINK_DOWN</span><br><span class="line">     speed: 0 Mbps now, 0 Mbps max</span><br><span class="line">OFPT_GET_CONFIG_REPLY (xid=0x4): frags=normal miss_send_len=0</span><br></pre></td></tr></table></figure></p>
<p>查看br-int流表规则ovs-ofctl  dump-flows  br-int<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kvm-app-6:~ # ovs-ofctl  dump-flows  br-int</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x8372d932b48e5321, duration=5395.262s, table=0, n_packets=0, n_bytes=0, idle_age=5395, priority=10,icmp6,in_port=2,icmp_type=136 actions=resubmit(,24)</span><br><span class="line"> cookie=0x8372d932b48e5321, duration=5395.261s, table=0, n_packets=505, n_bytes=21210, idle_age=7, priority=10,arp,in_port=2 actions=resubmit(,24)</span><br><span class="line"> cookie=0x8372d932b48e5321, duration=7776.549s, table=0, n_packets=366813, n_bytes=36441400, idle_age=5395, priority=2,in_port=1 actions=drop</span><br><span class="line"> cookie=0x8372d932b48e5321, duration=5395.264s, table=0, n_packets=817, n_bytes=74814, idle_age=4, priority=9,in_port=2 actions=resubmit(,25)</span><br><span class="line"> cookie=0x8372d932b48e5321, duration=5395.379s, table=0, n_packets=840145, n_bytes=83511042, idle_age=0, priority=3,in_port=1,dl_vlan=11 actions=mod_vlan_vid:1,NORMAL</span><br><span class="line"> cookie=0x8372d932b48e5321, duration=7776.964s, table=0, n_packets=4, n_bytes=320, idle_age=7776, priority=0 actions=NORMAL</span><br><span class="line"> cookie=0x8372d932b48e5321, duration=7776.965s, table=23, n_packets=0, n_bytes=0, idle_age=7776, priority=0 actions=drop</span><br><span class="line"> cookie=0x8372d932b48e5321, duration=5395.263s, table=24, n_packets=0, n_bytes=0, idle_age=5395, priority=2,icmp6,in_port=2,icmp_type=136,nd_target=fe80::f816:3eff:fe1f:1199 actions=NORMAL</span><br><span class="line"> cookie=0x8372d932b48e5321, duration=5395.262s, table=24, n_packets=502, n_bytes=21084, idle_age=7, priority=2,arp,in_port=2,arp_spa=10.8.25.220 actions=resubmit(,25)</span><br><span class="line"> cookie=0x8372d932b48e5321, duration=7776.964s, table=24, n_packets=3, n_bytes=126, idle_age=5357, priority=0 actions=drop</span><br><span class="line"> cookie=0x8372d932b48e5321, duration=5395.265s, table=25, n_packets=1319, n_bytes=95898, idle_age=4, priority=2,in_port=2,dl_src=fa:16:3e:1f:11:99 actions=NORMAL</span><br></pre></td></tr></table></figure></p>
<p>查看br-ex交换机接口信息ovs-ofctl  show br-ex<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> kvm-app-6:~ # ovs-ofctl  show br-ex</span><br><span class="line">OFPT_FEATURES_REPLY (xid=0x2): dpid:0000aa081303781a</span><br><span class="line">n_tables:254, n_buffers:0</span><br><span class="line">capabilities: FLOW_STATS TABLE_STATS PORT_STATS QUEUE_STATS ARP_MATCH_IP</span><br><span class="line">actions: output enqueue set_vlan_vid set_vlan_pcp strip_vlan mod_dl_src mod_dl_dst mod_nw_src mod_nw_dst mod_nw_tos mod_tp_src mod_tp_dst</span><br><span class="line"> 1(bond0): addr:82:01:9b:1b:28:c9</span><br><span class="line">     config:     0</span><br><span class="line">     state:      0</span><br><span class="line">     speed: 0 Mbps now, 0 Mbps max</span><br><span class="line"> 2(phy-br-ex): addr:c2:06:bb:33:da:7a</span><br><span class="line">     config:     0</span><br><span class="line">     state:      0</span><br><span class="line">     speed: 0 Mbps now, 0 Mbps max</span><br><span class="line"> LOCAL(br-ex): addr:aa:08:13:03:78:1a</span><br><span class="line">     config:     PORT_DOWN</span><br><span class="line">     state:      LINK_DOWN</span><br><span class="line">     speed: 0 Mbps now, 0 Mbps max</span><br><span class="line">OFPT_GET_CONFIG_REPLY (xid=0x4): frags=normal miss_send_len=0</span><br></pre></td></tr></table></figure></p>
<p>查看br-ex流表信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kvm-app-6:~ # ovs-ofctl  dump-flows br-ex</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x90f6220dc9413e6e, duration=5441.562s, table=0, n_packets=1328, n_bytes=96564, idle_age=3, priority=4,in_port=2,dl_vlan=1 actions=mod_vlan_vid:11,NORMAL</span><br><span class="line"> cookie=0x90f6220dc9413e6e, duration=7822.731s, table=0, n_packets=0, n_bytes=0, idle_age=7822, priority=2,in_port=2 actions=drop</span><br><span class="line"> cookie=0x90f6220dc9413e6e, duration=7822.733s, table=0, n_packets=1213423, n_bytes=120613616, idle_age=0, priority=0 actions=NORMAL</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2020/01/01/openvswit_vlan流表/" data-id="ck8bu1tgi002c1ojx1ksu3nzm" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-linux-nmap详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/15/linux-nmap详解/" class="article-date">
  <time datetime="2019-12-15T01:42:54.000Z" itemprop="datePublished">2019-12-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/15/linux-nmap详解/">nmap工具详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-1-nmap基础"><a href="#1-1-nmap基础" class="headerlink" title="1.1 nmap基础"></a>1.1 nmap基础</h3><p>在运维过程中有时需要主机存活性探测，一般是namp、tcpdump命令结合使用，相关工具包安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ ]# yum install  nmap tcpdump</span><br></pre></td></tr></table></figure></p>
<p>列出几种nmap命令语法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-sS/sT/sA/sW/sM: TCP SYN/Connect()/ACK/Window/Maimon scans</span><br><span class="line">-sU: UDP Scan</span><br><span class="line">-sP: ping Scan</span><br></pre></td></tr></table></figure></p>
<p>下面我们在2台主机间探测，一主机发nmap探测，另一主机tcpdump抓包分析</p>
<p>在A主机正常发一个ping包看看正常情况下的icmp包<br> ping -c 1 10.17.200.36</p>
<p> 在B主机抓包发现icmp包有去有回<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ ]# tcpdump -np -i ens192 src host 10.17.200.14</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on ens192, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">16:08:38.392418 IP 10.17.200.14 &gt; 10.17.200.36: ICMP echo request, id 5220, seq 1, length 64</span><br><span class="line">16:08:43.400811 ARP, Reply 10.17.200.14 is-at 00:50:56:b9:b2:fb, length 46</span><br></pre></td></tr></table></figure></p>
<p>可在一台主机临时禁用icmp协议,再用ping将探测不到这台主机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all</span><br></pre></td></tr></table></figure></p>
<h3 id="1-2-nmap-ping探测"><a href="#1-2-nmap-ping探测" class="headerlink" title="1.2 nmap ping探测"></a>1.2 nmap ping探测</h3><p>我们开始nmap ping探测， -n表示不进行DNS解析<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ ]# nmap -n -sP 10.17.200.36</span><br><span class="line">Starting Nmap 6.40 ( http://nmap.org ) at 2019-01-15 16:12 CST</span><br><span class="line">Nmap scan report for 10.17.200.36</span><br><span class="line">Host is up (0.00030s latency).</span><br><span class="line">MAC Address: 00:50:56:B9:21:18 (VMware)</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 0.05 seconds</span><br></pre></td></tr></table></figure></p>
<p>在B主机探测发现只收到了对方发的请求包，并未回应，但是还是认为这台主机是存活的，这样提高了探测效率<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost roles]# tcpdump -np -i ens192 src host 10.17.200.14</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on ens192, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">16:12:28.972321 ARP, Request who-has 10.17.200.36 (Broadcast) tell 10.17.200.14, length 46</span><br></pre></td></tr></table></figure></p>
<h3 id="1-3-nmapSYN探测"><a href="#1-3-nmapSYN探测" class="headerlink" title="1.3 nmapSYN探测"></a>1.3 nmapSYN探测</h3><p>我们开始nmap TCP的SYN探测， -n表示不进行DNS解析<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ ]# nmap -n -PE 10.17.200.36</span><br><span class="line">Starting Nmap 6.40 ( http://nmap.org ) at 2019-01-15 16:20 CST</span><br><span class="line">Nmap scan report for 10.17.200.36</span><br><span class="line">Host is up (0.00014s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT    STATE    SERVICE</span><br><span class="line">22/tcp  open     ssh</span><br><span class="line">445/tcp filtered microsoft-ds</span><br><span class="line">MAC Address: 00:50:56:B9:21:18 (VMware)</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 1.33 seconds</span><br></pre></td></tr></table></figure></p>
<p>在B主机探测发现，A主机对B主机的各服务都发送了TCP　SYN包来进行探测<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@　]# tcpdump -np -i ens192 src host 10.17.200.14</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on ens192, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">16:20:07.124327 ARP, Request who-has 10.17.200.36 (Broadcast) tell 10.17.200.14, length 46</span><br><span class="line">16:20:07.148867 IP 10.17.200.14.40911 &gt; 10.17.200.36.rtsp: Flags [S], seq 3791226815, win 1024, options [mss 1460], length 0</span><br><span class="line">16:20:07.148882 IP 10.17.200.14.40911 &gt; 10.17.200.36.smtp: Flags [S], seq 3791226815, win 1024, options [mss 1460], length 0</span><br><span class="line">16:20:07.148906 IP 10.17.200.14.40911 &gt; 10.17.200.36.domain: Flags [S], seq 3791226815, win 1024, options [mss 1460], length 0</span><br><span class="line">16:20:07.148943 IP 10.17.200.14.40911 &gt; 10.17.200.36.https: Flags [S], seq 3791226815, win 1024, options [mss 1460], length 0</span><br><span class="line">16:20:07.148950 IP 10.17.200.14.40911 &gt; 10.17.200.36.mysql: Flags [S], seq 3791226815, win 1024, options [mss 1460], length 0</span><br><span class="line">16:20:07.148950 IP 10.17.200.14.40911 &gt; 10.17.200.36.ssh: Flags [S], seq 3791226815, win 1024, options [mss 1460], length 0</span><br><span class="line">信息太多，略过...</span><br><span class="line">16:20:12.152833 ARP, Reply 10.17.200.14 is-at 00:50:56:b9:b2:fb, length 46</span><br></pre></td></tr></table></figure></p>
<h3 id="1-4-arping"><a href="#1-4-arping" class="headerlink" title="1.4 arping"></a>1.4 arping</h3><p>另外补充一下，<code>arping -D</code>可有效检测IP地址冲突问题,如果命令<code>echo $?</code>返回值为0则表示地址冲突，1则表示不冲突.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ ]# arping  -D  -c 2   -I ens192   10.17.200.36</span><br><span class="line">ARPING 10.17.200.36 from 0.0.0.0 ens192</span><br><span class="line">Unicast reply from 10.17.200.36 [00:50:56:B9:21:18]  0.887ms</span><br><span class="line">Sent 1 probes (1 broadcast(s))</span><br><span class="line">Received 1 response(s)</span><br></pre></td></tr></table></figure></p>
<h3 id="1-5-总结"><a href="#1-5-总结" class="headerlink" title="1.5 总结"></a>1.5 总结</h3><ul>
<li>nmap -sP 可进行ping检测</li>
<li>nmap -PE 可进行tcp SYN检测</li>
<li>nmap -n -sP -PE 可进行ping与SYN结合检测,以免漏扫</li>
<li>arping -D 可进行地址冲突检测</li>
</ul>
<p>&lt;完结&gt;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/12/15/linux-nmap详解/" data-id="ck8bu1tg6001s1ojxnjtk6dxk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-linux-disk" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/15/linux-disk/" class="article-date">
  <time datetime="2019-12-15T01:42:54.000Z" itemprop="datePublished">2019-12-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/15/linux-disk/">linux disk</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Ubuntu系统分区信息查看：<code>fdisk /dev/vda</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Command (m for help): p</span><br><span class="line">Disk /dev/vda: 60 GiB, 64424509440 bytes, 125829120 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel type: dos</span><br><span class="line">Disk identifier: 0x630fdccb</span><br><span class="line"></span><br><span class="line">Device     Boot   Start       End   Sectors  Size Id Type</span><br><span class="line">/dev/vda1  *       2048   1953791   1951744  953M 83 Linux</span><br><span class="line">/dev/vda2       1953792 125829119 123875328 59.1G 83 Linux</span><br></pre></td></tr></table></figure></p>
<p>Sart、End、Sectors单位都是扇区， 1扇区=512bytes，那么2扇区就是1KB 通常称为一个block块，那么就有了<code>2sectors=1KB=1 block</code>,可以通过<code>blockdev --getsz /dev/vda</code>得到整块盘扇区数<br><code>像上面1953791-2048+1=1951744</code>扇,953M=1951744/2/1024KB</p>
<p>CentOS差别可能就是 Blocks数显示，上面说了1Block=1KB<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Disk /dev/vda: 64.4 GB, 64424509440 bytes, 125829120 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0x000afe6d</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/vda1   *        2048     4196351     2097152   83  Linux</span><br><span class="line">/dev/vda2         4196352   125829119    60816384   83  Linux</span><br></pre></td></tr></table></figure></p>
<p>我来验证一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4196351-2048+1得到扇区数，(4196351-2048+1)/2=2097152刚好等于Blocks数，也就是2097152KB=2048MB=2GB</span><br></pre></td></tr></table></figure></p>
<p>我们再来学习下dd命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bs参数代表逻辑块大小，默认单位是扇区，bs=512代表一个扇区，也就是512bytes</span><br><span class="line">count参数代表逻辑块的个数或扇区数，那么处理的存储大小就是bs*count</span><br><span class="line">skip 表示跳过if 设备的扇区数开始读数据,skip=200代表200个扇区，也就是100KB</span><br><span class="line">seek表示跳过of设备的扇区数开始写数据,seek=400代表400个扇区，也就是200KB</span><br></pre></td></tr></table></figure></p>
<p>那么学了这些有什么用呢？<br>一个裸盘有硬件raid卡信息是不能正常被格式化的，这个raid信息会存在硬盘的最后63个扇区的地方，我们可以用dd复盖掉<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">snumber=$(($(blockdev --getsz /dev/sda)-63))</span><br><span class="line">dd if=/dev/zero of=/dev/sda bs=512 count=63 seek=$snumber</span><br></pre></td></tr></table></figure></p>
<p>总结：</p>
<ul>
<li>一个扇区512bytes , 1Block=1KB=2扇区</li>
<li>dd参数的skip针对if设备，seek针对of设备（跳过多少扇区再处理）</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/12/15/linux-disk/" data-id="ck8bu1tfz001g1ojx9k5ytq73" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-linux-proxy_ARP" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/15/linux-proxy_ARP/" class="article-date">
  <time datetime="2019-12-15T01:42:54.000Z" itemprop="datePublished">2019-12-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/15/linux-proxy_ARP/">代理ARP学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="代理ARP学习"><a href="#代理ARP学习" class="headerlink" title="代理ARP学习"></a>代理ARP学习</h2><p>参考<a href="https://cloud.tencent.com/developer/article/1495301" target="_blank" rel="noopener">戳穿 Calico 的谎言</a></p>
<p>什么是代理ARP？<br>当 ARP 请求目标跨网段时，网关设备收到此ARP请求会用自己的MAC地址返回给请求者，这就是代理ARP .</p>
<p>知识点： </p>
<ul>
<li>跨网段通信时会发广播得到网关MAC</li>
<li>之后发出的网络数据包目标MAC是网关的MAC</li>
<li>网关的IP地址不会出现在任何网络包头中</li>
<li>因此，没有人在乎网关地址是否真的存在，只要设备能响应ARP就行了</li>
</ul>
<p>我这里用了2台linux主机实验，主机A：192.168.1.109 主机B:192.168.1.110<br>主机A：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ip  link add veth0 type veth peer name veth0_p</span><br><span class="line">ip netns add ns0</span><br><span class="line">ip link set veth0_p netns ns0</span><br><span class="line">ip netns exec ns0  ip link set veth0_p name eth0</span><br><span class="line">ip netns exec ns0  ip a add 10.10.10.10/24 dev eth0</span><br><span class="line">ip netns exec ns0 ip link set eth0 up</span><br><span class="line">ip netns exec ns0 ip route add 169.254.1.1 dev eth0</span><br><span class="line">ip netns exec ns0 ip route add default via 169.254.1.1 dev eth0</span><br><span class="line">[root@testarp-A ~]#ip netns exec ns0 route -n    # 命名空间里的路由</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         169.254.1.1     0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">10.10.10.0      0.0.0.0         255.255.255.0   U     0      0        0 eth0</span><br><span class="line">169.254.1.1     0.0.0.0         255.255.255.255 UH    0      0        0 eth0</span><br><span class="line">ip link set veth0 up</span><br><span class="line">ip route add 10.10.10.10 dev veth0</span><br><span class="line">ip route add   10.10.10.20 via 192.168.1.110  dev eth0</span><br></pre></td></tr></table></figure></p>
<p>主机B:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ip  link add veth0 type veth peer name veth0_p</span><br><span class="line">ip netns add ns0</span><br><span class="line">ip link set veth0_p netns ns0</span><br><span class="line">ip netns exec ns0  ip link set veth0_p name eth0</span><br><span class="line">ip netns exec ns0  ip a add 10.10.10.20/24 dev eth0</span><br><span class="line">ip netns exec ns0 ip link set eth0 up</span><br><span class="line">ip netns exec ns0 ip route add 169.254.1.1 dev eth0</span><br><span class="line">ip netns exec ns0 ip route add default via 169.254.1.1 dev eth0</span><br><span class="line">[root@testarp-B ~]# ip netns exec ns0 route -n  </span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         169.254.1.1     0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">10.10.10.0      0.0.0.0         255.255.255.0   U     0      0        0 eth0</span><br><span class="line">169.254.1.1     0.0.0.0         255.255.255.255 UH    0      0        0 eth0</span><br><span class="line">ip link set veth0 up</span><br><span class="line">ip route add 10.10.10.20 dev veth0</span><br><span class="line">ip route add   10.10.10.10 via 192.168.1.109  dev eth0</span><br></pre></td></tr></table></figure></p>
<p>Linux主机打开路由转发<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></table></figure></p>
<p>网卡开启代理ARP功能<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/conf/veth0/proxy_arp</span><br></pre></td></tr></table></figure></p>
<p>主机A上网络通信测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@testarp-A ~]# ip netns exec ns0 ping 10.10.10.20</span><br><span class="line">PING 10.10.10.20 (10.10.10.20) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.10.10.20: icmp_seq=1 ttl=62 time=0.951 ms</span><br><span class="line">64 bytes from 10.10.10.20: icmp_seq=2 ttl=62 time=0.484 ms</span><br><span class="line">64 bytes from 10.10.10.20: icmp_seq=3 ttl=62 time=0.556 ms</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@testarp-A ~]# tcpdump  -nni veth0</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on veth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">08:18:15.999200 IP 10.10.10.10 &gt; 10.10.10.20: ICMP echo request, id 1486, seq 1, length 64</span><br><span class="line">08:18:16.000288 IP 10.10.10.20 &gt; 10.10.10.10: ICMP echo reply, id 1486, seq 1, length 64</span><br><span class="line">08:18:21.008712 ARP, Request who-has 10.10.10.20 tell 10.10.10.10, length 28</span><br><span class="line">08:18:21.008757 ARP, Reply 10.10.10.20 is-at ee:46:7c:2e:d9:ba, length 28</span><br></pre></td></tr></table></figure>
<p>注意： 这里veth0充当路由角色代理ARP,  who is 10.10.10.20 ,返回自己MAC<code>ee:46:7c:2e:d9:ba</code>来响应.</p>
<p>转发过程分析：<br>1 广播寻找目标IP对应MAC是谁？<br>2 根据路由规则所有数据包都会转发到169.254.1.1，寻找169.254.1.1MAC是谁？<br>2 vet0开启代理ARP进行ARP拦截，返回自己MAC<code>ee:46:7c:2e:d9:ba</code>给以响应<br>3 封包目标IP为10.10.10.20，MAC为<code>ee:46:7c:2e:d9:ba</code>,发出这样的数据包<br>4 主机A查询本地路由，匹配<code>10.10.10.20 via 192.168.1.110 dev eth0</code> 会把包发送给<code>192.168.1.110</code><br>5 主机B收到<code>10.10.10.20</code>的包时，匹配本地路由<code>10.10.10.20 dev veth0 scope link</code>,数据包发送到veth0上<br>6  完成通信，回程类似</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/12/15/linux-proxy_ARP/" data-id="ck8bu1tg5001q1ojx6y282fp2" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-k8s_pod1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/01/k8s_pod1/" class="article-date">
  <time datetime="2019-12-01T12:51:41.000Z" itemprop="datePublished">2019-12-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器世界/">容器世界</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/01/k8s_pod1/">k8s_pod资源清单学习1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        The article has been encrypted, please enter your password to view.<br>
        
          <p class="article-more-link">
            <a href="/2019/12/01/k8s_pod1/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/12/01/k8s_pod1/" data-id="ck8bu1tfu00171ojxa0zrurax" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-Kubernetes-dashboard-TLS坑" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/11/Kubernetes-dashboard-TLS坑/" class="article-date">
  <time datetime="2019-06-11T12:51:41.000Z" itemprop="datePublished">2019-06-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/容器世界/">容器世界</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/11/Kubernetes-dashboard-TLS坑/">kubernetes-dashboard-TLS坑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        The article has been encrypted, please enter your password to view.<br>
        
          <p class="article-more-link">
            <a href="/2019/06/11/Kubernetes-dashboard-TLS坑/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/06/11/Kubernetes-dashboard-TLS坑/" data-id="ck8bu1tet00011ojxj2qsroe9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-python-Celery-Flask" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/10/python-Celery-Flask/" class="article-date">
  <time datetime="2019-02-10T09:03:01.000Z" itemprop="datePublished">2019-02-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Python/">Python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/10/python-Celery-Flask/">python-celery-Flask</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一、基本使用"><a href="#一、基本使用" class="headerlink" title="一、基本使用"></a>一、基本使用</h3><p>Celery是由Python开发的一个简单、灵活、可靠的处理大量任务的分发系统，可以实时处理任务，也可以定时异步处理任务。<br>每次分发任务后得到一个ID，然后根据这个ID查询任务执行情况。</p>
<p>并且celery需要rabbitMQ、Redis等充当broker来进行消息的接收。</p>
<p>安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install celery eventlet   # windows系统需要eventlet模块</span><br></pre></td></tr></table></figure></p>
<p>下面我们来快速上手celery<br>编辑s1.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery import Celery</span><br><span class="line"></span><br><span class="line">cel = Celery(&apos;xxx&apos;,</span><br><span class="line">             broker=&quot;redis://192.168.1.40&quot;,</span><br><span class="line">             backend=&apos;redis://192.168.1.40&apos;)</span><br><span class="line"></span><br><span class="line">@cel.task</span><br><span class="line">def f1(x,y):</span><br><span class="line">    return x+y</span><br></pre></td></tr></table></figure></p>
<p>然后把s1这个work工作起来，进入命令终端,如果在linux系统，不用添加参数-P eventlet<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\pro\xxx_dir&gt; celery worker -A s1 -l info  -P eventlet</span><br></pre></td></tr></table></figure></p>
<p>编辑s2.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">import datetime</span><br><span class="line">from s1 import f1</span><br><span class="line"></span><br><span class="line"># 立即执行</span><br><span class="line">result = f1.delay(4,6)</span><br><span class="line">print(result.id)</span><br><span class="line"></span><br><span class="line"># 定时执行</span><br><span class="line">ctime = datetime.datetime.now()</span><br><span class="line"># ctime = datetime.datetime(year=2019,month=2,day=21,hour=14,minute=8)</span><br><span class="line">utc_time = datetime.datetime.utcfromtimestamp(ctime.timestamp())</span><br><span class="line">s10 = datetime.timedelta(seconds=10)</span><br><span class="line">ctime_x = utc_time + s10</span><br><span class="line">result = f1.apply_async(args=[1,3],eta=ctime_x)</span><br><span class="line">print(result.id)</span><br></pre></td></tr></table></figure></p>
<p>编辑s3.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery.result import  AsyncResult</span><br><span class="line">from demo1.s1 import cel</span><br><span class="line"></span><br><span class="line">async = AsyncResult(id=&quot;f43bce52-9503-475e-9d19-4a46ed910a8e&quot;,app=cel)</span><br><span class="line"></span><br><span class="line">if async.successful():</span><br><span class="line">    ret = async.get() # 获取值</span><br><span class="line">    #async.forget()  #  删除值</span><br><span class="line">    print(ret)</span><br><span class="line">elif async.failed():</span><br><span class="line">    print(&apos;执行失败&apos;)</span><br><span class="line">elif async.status == &apos;PENDING&apos;:</span><br><span class="line">    print(&apos;任务等待中被执行&apos;)</span><br><span class="line">elif async.status == &apos;RETRY&apos;:</span><br><span class="line">    print(&apos;任务异常后正在重试&apos;)</span><br><span class="line">elif async.status == &apos;STARTED&apos;:</span><br><span class="line">    print(&apos;任务已经开始被执行&apos;)</span><br><span class="line">else:</span><br><span class="line">    print(&quot;任务执行失败&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async.revoke()    #  取消一个任务，当一个任务正在执行，不能取消</span><br><span class="line">async.revoke(terminate=True)  # 终止一个任务，当一个任务正在执行，可以被终止</span><br></pre></td></tr></table></figure></p>
<h3 id="二、多目录结构"><a href="#二、多目录结构" class="headerlink" title="二、多目录结构"></a>二、多目录结构</h3><p>经过上面快速上手的学习，了解了celery的基本使用，那么重组一下代，形成项目中多目录结构看看相互之间如何调用？</p>
<p>创建一个celery_tasks的目录，里面一般保存2类文件，其中一个文件名称必须为celery,另一类就是定义task任务的文件，可以有多个。</p>
<p>定义celery_tasks/celery.py文件,如果有多个task任务文件，可以用includ列表包含进来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery import Celery</span><br><span class="line"># from celery.schedules import crontab</span><br><span class="line"></span><br><span class="line">cel = Celery(&apos;xxxxxx&apos;,</span><br><span class="line">                broker=&apos;redis://192.168.1.40:6379&apos;,</span><br><span class="line">                backend=&apos;redis://192.168.1.40:6379&apos;,</span><br><span class="line">                include=[&apos;celery_tasks.task1&apos;,)</span><br><span class="line">                #include=[&apos;celery_tasks.task1&apos;,&apos;celery_tasks.task2&apos;])</span><br><span class="line"></span><br><span class="line"># 时区</span><br><span class="line">cel.conf.timezone = &apos;Asia/Shanghai&apos;</span><br><span class="line"># 是否使用UTC</span><br><span class="line">cel.conf.enable_utc = False</span><br></pre></td></tr></table></figure></p>
<p>在多目录结构中，跑celery  work时不用指定到文件，指定目录即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\pro\xxx_dir&gt; celery worker -A celery_tasks -l info  -P eventlet</span><br></pre></td></tr></table></figure></p>
<p>定义celery_tasks/task1.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from .celery import cel</span><br><span class="line"></span><br><span class="line">@cel.task</span><br><span class="line">def f1(x,y):</span><br><span class="line">    return  x+y</span><br></pre></td></tr></table></figure></p>
<p>有了celery.py文件和task任务文件，我们就可以在任意地方调用任务了。</p>
<p>比如定义test/exec1.py文件来执行任务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery_tasks.task1 import f1</span><br><span class="line"></span><br><span class="line">result = f1.delay(4,6)</span><br><span class="line">print(result.id)</span><br></pre></td></tr></table></figure></p>
<p>定义test/exec2.py文件来获取任务执行结果,需要提供任务ID<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from celery_tasks.celery import cel</span><br><span class="line">from celery.result import AsyncResult</span><br><span class="line"></span><br><span class="line">async = AsyncResult(id=&quot;be6bb021-da48-46a9-b1bc-94b987f7c8a7&quot;,app=cel)</span><br><span class="line"></span><br><span class="line">if async.successful():</span><br><span class="line">    print(async.get())</span><br><span class="line">else:</span><br><span class="line">    print(&quot;任务执行失败&quot;)</span><br></pre></td></tr></table></figure></p>
<h3 id="三、Flask中的例用"><a href="#三、Flask中的例用" class="headerlink" title="三、Flask中的例用"></a>三、Flask中的例用</h3><p>有了上面celery的认识，我们来简单写点代码，看一下在Flask框架中celery是如何使用的？</p>
<p>定义Flask项目启动文件app.py</p>
<p>写线上代码时是要把任务保存在数据库中的，这里仅作示例就保存在了HISTORY全局变量中了.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from flask import Flask,request,render_template,redirect</span><br><span class="line"></span><br><span class="line">from celery_tasks.task2 import  deploy</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">HISTORY = []</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/index&apos;,methods=[&quot;GET&quot;,&quot;POST&quot;])</span><br><span class="line">def index():</span><br><span class="line">    if  request.method == &quot;GET&quot;:</span><br><span class="line">        return render_template(&apos;index.html&apos;,history=HISTORY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&apos;/publish&apos;,methods=[&quot;GET&quot;,&quot;POST&quot;])</span><br><span class="line">def publish():</span><br><span class="line">    if  request.method == &quot;GET&quot;:</span><br><span class="line">        return render_template(&apos;publish.html&apos;)</span><br><span class="line">    else:</span><br><span class="line">        version = request.form.get(&quot;version&quot;)</span><br><span class="line">        hosts = request.form.getlist(&quot;hosts&quot;)</span><br><span class="line">        print(version,hosts)</span><br><span class="line"></span><br><span class="line">        import datetime</span><br><span class="line">        ctime = datetime.datetime.now()</span><br><span class="line">        utc_time = datetime.datetime.utcfromtimestamp(ctime.timestamp())</span><br><span class="line">        ctime_10 = utc_time + datetime.timedelta(seconds=10)</span><br><span class="line">        result = deploy.apply_async(args=[version,hosts],eta=ctime_10)</span><br><span class="line">        HISTORY.append(&#123;&quot;version&quot;:version,&quot;hosts&quot;:hosts,&quot;task_id&quot;:result.id&#125;)</span><br><span class="line">        print(HISTORY)</span><br><span class="line">        return redirect(&quot;/index&quot;)</span><br><span class="line"></span><br><span class="line">from celery.result import AsyncResult</span><br><span class="line">from celery_tasks.celery import cel</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/check_result&apos;,methods=[&quot;GET&quot;,&quot;POST&quot;])</span><br><span class="line">def check_result():</span><br><span class="line">    task_id = request.args.get(&quot;task_id&quot;)</span><br><span class="line">    async = AsyncResult(id=task_id,app=cel)</span><br><span class="line">    if async.successful():</span><br><span class="line">        result = async.get()</span><br><span class="line">        print(result)</span><br><span class="line">        # result.forget() # 将结果删除</span><br><span class="line">        return &quot;执行成功&quot;</span><br><span class="line">    elif async.failed():</span><br><span class="line">        return &apos;执行失败&apos;</span><br><span class="line">    elif async.status == &apos;PENDING&apos;:</span><br><span class="line">        return &apos;任务等待中被执行&apos;</span><br><span class="line">    elif async.status == &apos;RETRY&apos;:</span><br><span class="line">        return &apos;任务异常后正在重试&apos;</span><br><span class="line">    elif async.status == &apos;STARTED&apos;:</span><br><span class="line">        return &apos;任务已经开始被执行&apos;</span><br><span class="line">    else:</span><br><span class="line">        return &quot;unkown status&quot;</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/cancel&apos;, methods=[&quot;GET&quot;, &quot;POST&quot;])</span><br><span class="line">def cancel():</span><br><span class="line">    task_id = request.args.get(&quot;task_id&quot;)</span><br><span class="line">    async =AsyncResult(id=task_id,app=cel)</span><br><span class="line">    async.revoke(terminate=True)</span><br><span class="line">    for i in HISTORY:</span><br><span class="line">        if task_id in i.values():</span><br><span class="line">            HISTORY.remove(i)</span><br><span class="line">    return redirect(&quot;/index&quot;)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure></p>
<p>定义其中用到的templates/index.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;发布系统&lt;/h1&gt;</span><br><span class="line">&lt;a href=&quot;/publish&quot;&gt;添加发布任务&lt;/a&gt;</span><br><span class="line">&lt;table&gt;</span><br><span class="line">    &#123;% for row in history %&#125;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">        &lt;td&gt;&#123;&#123; row.task_id &#125;&#125;&lt;/td&gt;</span><br><span class="line">        &lt;td&gt;&#123;&#123; row.version &#125;&#125;&lt;/td&gt;</span><br><span class="line">        &#123;% for host in  row.hosts %&#125;</span><br><span class="line">           &lt;td&gt;</span><br><span class="line">              &lt;span&gt;&#123;&#123; host &#125;&#125;&lt;/span&gt;</span><br><span class="line">           &lt;/td&gt;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">        &lt;td&gt;&lt;a href=&quot;/check_result?task_id=&#123;&#123; row.task_id &#125;&#125;&quot;&gt;查看&lt;/a&gt;&lt;/td&gt;</span><br><span class="line">        &lt;td&gt;&lt;a href=&quot;/cancel?task_id=&#123;&#123; row.task_id &#125;&#125;&quot;&gt;取消&lt;/a&gt;&lt;/td&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>定义其中用到的templates/publish.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span><br><span class="line">    &lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;version&quot; placeholder=&quot;请输入要发布的版本&quot;&gt;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">        &lt;select name=&quot;hosts&quot; multiple=&quot;multiple&quot;&gt;</span><br><span class="line">            &lt;option value=&quot;c1.com&quot;&gt;c1.com&lt;/option&gt;</span><br><span class="line">            &lt;option value=&quot;c2.com&quot;&gt;c2.com&lt;/option&gt;</span><br><span class="line">            &lt;option value=&quot;c3.com&quot;&gt;c3.com&lt;/option&gt;</span><br><span class="line">        &lt;/select&gt;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot; value=&quot;提交&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>定义其中的celery_tasks.task2.py文件,这里的deploy是真正定义任务的地方.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">from .celery import cel</span><br><span class="line"></span><br><span class="line">@cel.task</span><br><span class="line">def deploy(version,hosts):</span><br><span class="line">    print(version, hosts) # 定义想要执行的任务代码</span><br><span class="line">    return &apos;deploy ok&apos;</span><br></pre></td></tr></table></figure></p>
<p>同样别望了先把work跑起来,再启动Flask<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\pro\xxx_dir&gt; celery worker -A celery_tasks -l info  -P eventlet</span><br></pre></td></tr></table></figure></p>
<h3 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h3><p>还需要多写代码在项目中总结celery…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/02/10/python-Celery-Flask/" data-id="ck8bu1thj003g1ojxe6tgq0sz" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  
    <article id="post-ansible-Callback-02" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/12/ansible-Callback-02/" class="article-date">
  <time datetime="2019-01-12T12:39:12.000Z" itemprop="datePublished">2019-01-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/ansible/">ansible</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/12/ansible-Callback-02/">ansible callback 重写</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-1-adhoc-callback重写"><a href="#1-1-adhoc-callback重写" class="headerlink" title="1.1 adhoc callback重写"></a>1.1 adhoc callback重写</h3><p>adhoc-callback.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">import os,sys,json</span><br><span class="line">import ansible.constants as C</span><br><span class="line">from ansible.parsing.dataloader import  DataLoader</span><br><span class="line">from ansible.vars.manager import  VariableManager</span><br><span class="line">from ansible.inventory.manager import  InventoryManager</span><br><span class="line">from ansible.playbook import Play</span><br><span class="line">from ansible.executor.task_queue_manager import  TaskQueueManager</span><br><span class="line">from ansible.executor.playbook_executor import  PlaybookExecutor</span><br><span class="line">from ansible.plugins.callback import CallbackBase</span><br><span class="line">from ansible.inventory.host import  Host,Group</span><br><span class="line">from  collections import namedtuple</span><br><span class="line"></span><br><span class="line">BaseDir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">source = os.path.join(BaseDir,&apos;dir1/inventory/multinode&apos;)</span><br><span class="line">loader = DataLoader()   # 实例化loader对象</span><br><span class="line">myinven = InventoryManager(loader=loader,sources=[source,])   # 实例化inventory对象</span><br><span class="line">print(myinven.get_groups_dict())</span><br><span class="line"></span><br><span class="line">varmanager = VariableManager(loader=loader,inventory=myinven)  # 实例化VariableManager对象</span><br><span class="line"></span><br><span class="line">#^#Options 选项</span><br><span class="line">Options = namedtuple(&apos;Options&apos;,[</span><br><span class="line">                &apos;connection&apos;,&apos;module_path&apos;, &apos;forks&apos;, &apos;timeout&apos;,  &apos;remote_user&apos;,</span><br><span class="line">                &apos;ask_pass&apos;, &apos;private_key_file&apos;, &apos;ssh_common_args&apos;, &apos;ssh_extra_args&apos;, &apos;sftp_extra_args&apos;,</span><br><span class="line">                &apos;scp_extra_args&apos;, &apos;become&apos;, &apos;become_method&apos;, &apos;become_user&apos;, &apos;ask_value_pass&apos;, &apos;verbosity&apos;,</span><br><span class="line">                &apos;check&apos;, &apos;listhosts&apos;, &apos;listtasks&apos;, &apos;listtags&apos;, &apos;syntax&apos;,&apos;diff&apos;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">options = Options(connection=&apos;smart&apos;, module_path=None, forks=100, timeout=10,</span><br><span class="line">                remote_user=&apos;root&apos;, ask_pass=False, private_key_file=None, ssh_common_args=None, ssh_extra_args=None,</span><br><span class="line">                sftp_extra_args=None, scp_extra_args=None, become=None, become_method=None,</span><br><span class="line">                become_user=&apos;root&apos;, ask_value_pass=False, verbosity=None, check=False, listhosts=False,</span><br><span class="line">                listtasks=False, listtags=False, syntax=False, diff=True)</span><br><span class="line"></span><br><span class="line">#^# 执行对象和模块</span><br><span class="line">play_data = dict(</span><br><span class="line">    name=&quot;Ansible adhoc example&quot;,</span><br><span class="line">    hosts=&apos;192.168.1.6,&apos;,</span><br><span class="line">    gather_facts=&apos;no&apos;,</span><br><span class="line">    tasks=[</span><br><span class="line">        dict(action=dict(module=&apos;shell&apos;, args=&quot;touch /tmp/sss.txt&quot;)),</span><br><span class="line">        # dict(action=dict(module=&apos;debug&apos;, args=dict(msg=&quot;&#123;&#123;  shell_out.stdout  &#125;&#125;&quot;))),</span><br><span class="line">     ],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">play = Play().load(data=play_data,loader=loader,variable_manager=varmanager)</span><br><span class="line"></span><br><span class="line">#^# 重写CallbackBase父类</span><br><span class="line">class AdhocResultsCollector(CallbackBase):</span><br><span class="line">    def __init__(self, *args, **kwargs):</span><br><span class="line">        super(AdhocResultsCollector, self).__init__(*args, **kwargs)</span><br><span class="line">        self.host_ok = &#123;&#125;</span><br><span class="line">        self.host_unreachable = &#123;&#125;</span><br><span class="line">        self.host_failed = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_unreachable(self, result):</span><br><span class="line">        self.host_unreachable[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_ok(self, result,  *args, **kwargs):</span><br><span class="line">        self.host_ok[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_failed(self, result,  *args, **kwargs):</span><br><span class="line">        self.host_failed[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">callback = AdhocResultsCollector()</span><br><span class="line">passwords = dict()</span><br><span class="line">tqm = TaskQueueManager(inventory=myinven,</span><br><span class="line">                       variable_manager=varmanager,</span><br><span class="line">                       loader=loader,options=options,</span><br><span class="line">                       passwords=passwords,</span><br><span class="line">                       stdout_callback=callback</span><br><span class="line">                       )</span><br><span class="line"></span><br><span class="line">result_status_code = tqm.run(play)</span><br><span class="line"></span><br><span class="line">print(callback.host_ok.items())</span><br><span class="line"></span><br><span class="line">result_raw = dict(</span><br><span class="line">    success = &#123;&#125;,</span><br><span class="line">    failed = &#123;&#125;,</span><br><span class="line">    unreachable = &#123;&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">for host,result in  callback.host_ok.items():</span><br><span class="line">    result_raw[&apos;success&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.host_failed.items():</span><br><span class="line">    result_raw[&apos;failed&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.host_unreachable.items():</span><br><span class="line">    result_raw[&apos;unreachable&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">print(json.dumps(result_raw,indent=4))</span><br></pre></td></tr></table></figure></p>
<h3 id="1-2-playbook-callback重写"><a href="#1-2-playbook-callback重写" class="headerlink" title="1.2 playbook callback重写"></a>1.2 playbook callback重写</h3><p>写入示例playbook文件site.yml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: 192.168.1.6</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    touch_file: &quot;site.txt&quot;</span><br><span class="line">  tasks:</span><br><span class="line">    - name: touch file</span><br><span class="line">      shell: &quot;touch /tmp/&#123;&#123;  touch_file &#125;&#125;&quot;</span><br></pre></td></tr></table></figure></p>
<p>编写play_book.py 文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line">import os,sys,json</span><br><span class="line">import ansible.constants as C</span><br><span class="line">from ansible.parsing.dataloader import  DataLoader</span><br><span class="line">from ansible.vars.manager import  VariableManager</span><br><span class="line">from ansible.inventory.manager import  InventoryManager</span><br><span class="line">from ansible.playbook import Play</span><br><span class="line">from ansible.executor.task_queue_manager import  TaskQueueManager</span><br><span class="line">from ansible.executor.playbook_executor import  PlaybookExecutor</span><br><span class="line">from ansible.plugins.callback import CallbackBase</span><br><span class="line">from ansible.inventory.host import  Host,Group</span><br><span class="line">from  collections import namedtuple</span><br><span class="line"></span><br><span class="line">BaseDir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">source = os.path.join(BaseDir,&apos;dir1/inventory/multinode&apos;)</span><br><span class="line">loader = DataLoader()   # 实例化loader对象</span><br><span class="line">myinven = InventoryManager(loader=loader,sources=[source,])   # 实例化inventory对象</span><br><span class="line">print(myinven.get_groups_dict())</span><br><span class="line"></span><br><span class="line">varmanager = VariableManager(loader=loader,inventory=myinven)  # 实例化VariableManager对象</span><br><span class="line"></span><br><span class="line"># Options 选项</span><br><span class="line">Options = namedtuple(&apos;Options&apos;,[</span><br><span class="line">                                &apos;connection&apos;,</span><br><span class="line">                                &apos;module_path&apos;,</span><br><span class="line">                                &apos;forks&apos;,</span><br><span class="line">                                &apos;timeout&apos;,</span><br><span class="line">                                &apos;remote_user&apos;,</span><br><span class="line">                                &apos;ask_pass&apos;,</span><br><span class="line">                                &apos;private_key_file&apos;,</span><br><span class="line">                                &apos;ssh_common_args&apos;,</span><br><span class="line">                                &apos;ssh_extra_args&apos;,</span><br><span class="line">                                &apos;sftp_extra_args&apos;,</span><br><span class="line">                                &apos;scp_extra_args&apos;,</span><br><span class="line">                                &apos;become&apos;,</span><br><span class="line">                                &apos;become_method&apos;,</span><br><span class="line">                                &apos;become_user&apos;,</span><br><span class="line">                                &apos;ask_value_pass&apos;,</span><br><span class="line">                                &apos;verbosity&apos;,</span><br><span class="line">                                &apos;check&apos;,</span><br><span class="line">                                &apos;listhosts&apos;,</span><br><span class="line">                                &apos;listtasks&apos;,</span><br><span class="line">                                &apos;listtags&apos;,</span><br><span class="line">                                &apos;syntax&apos;,</span><br><span class="line">                                &apos;diff&apos;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">options = Options(connection=&apos;smart&apos;,</span><br><span class="line">                  module_path=None,</span><br><span class="line">                  forks=100,</span><br><span class="line">                  timeout=10,</span><br><span class="line">                  remote_user=&apos;root&apos;,</span><br><span class="line">                  ask_pass=False,</span><br><span class="line">                  private_key_file=None,</span><br><span class="line">                  ssh_common_args=None,</span><br><span class="line">                  ssh_extra_args=None,</span><br><span class="line">                  sftp_extra_args=None,</span><br><span class="line">                  scp_extra_args=None,</span><br><span class="line">                  become=None,</span><br><span class="line">                  become_method=None,</span><br><span class="line">                  become_user=&apos;root&apos;,</span><br><span class="line">                  ask_value_pass=False,</span><br><span class="line">                  verbosity=None,</span><br><span class="line">                  check=False,</span><br><span class="line">                  listhosts=False,</span><br><span class="line">                  listtasks=False,</span><br><span class="line">                  listtags=False,</span><br><span class="line">                  syntax=False,</span><br><span class="line">                  diff=True,</span><br><span class="line">                  )</span><br><span class="line"></span><br><span class="line"># 重写CallbackBase父类</span><br><span class="line">class PlayBookResultsCollector(CallbackBase):</span><br><span class="line">    CALLBACK_VERSION = 2.0</span><br><span class="line">    def __init__(self, *args, **kwargs):</span><br><span class="line">        super(PlayBookResultsCollector, self).__init__(*args, **kwargs)</span><br><span class="line">        self.task_ok = &#123;&#125;</span><br><span class="line">        self.task_skipped = &#123;&#125;</span><br><span class="line">        self.task_failed = &#123;&#125;</span><br><span class="line">        self.task_status = &#123;&#125;</span><br><span class="line">        self.task_unreachable = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_ok(self, result, *args, **kwargs):</span><br><span class="line">        self.task_ok[result._host.get_name()]  = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_failed(self, result, *args, **kwargs):</span><br><span class="line">        self.task_failed[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_unreachable(self, result):</span><br><span class="line">        self.task_unreachable[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    def v2_runner_on_skipped(self, result):</span><br><span class="line">        self.task_ok[result._host.get_name()]  = result</span><br><span class="line"></span><br><span class="line">    def v2_playbook_on_stats(self, stats):</span><br><span class="line">        hosts = sorted(stats.processed.keys())</span><br><span class="line">        for h in hosts:</span><br><span class="line">            t = stats.summarize(h)</span><br><span class="line">            self.task_status[h] = &#123;</span><br><span class="line">                                       &quot;ok&quot;:t[&apos;ok&apos;],</span><br><span class="line">                                       &quot;changed&quot; : t[&apos;changed&apos;],</span><br><span class="line">                                       &quot;unreachable&quot;:t[&apos;unreachable&apos;],</span><br><span class="line">                                       &quot;skipped&quot;:t[&apos;skipped&apos;],</span><br><span class="line">                                       &quot;failed&quot;:t[&apos;failures&apos;]</span><br><span class="line">                                   &#125;</span><br><span class="line"># 执行对象和模块</span><br><span class="line">passwords = &#123;&#125;</span><br><span class="line">#传入playbooks, inventory, variable_manager, loader, options, passwords</span><br><span class="line">playbook = PlaybookExecutor(playbooks=[&apos;site.yml&apos;,],</span><br><span class="line">                            inventory=myinven,</span><br><span class="line">                            variable_manager=varmanager,</span><br><span class="line">                            loader=loader,</span><br><span class="line">                            options=options,</span><br><span class="line">                            passwords=passwords</span><br><span class="line">                            )</span><br><span class="line"></span><br><span class="line"># 把重写的CallbackBase父类加载进playbook</span><br><span class="line">callback = PlayBookResultsCollector()</span><br><span class="line">playbook._tqm._stdout_callback = callback</span><br><span class="line">playbook.run()</span><br><span class="line"></span><br><span class="line">result_raw = dict(</span><br><span class="line">    success = &#123;&#125;,</span><br><span class="line">    failed = &#123;&#125;,</span><br><span class="line">    unreachable = &#123;&#125;,</span><br><span class="line">    skipped = &#123;&#125;,</span><br><span class="line">    status = &#123;&#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">for host,result in  callback.task_ok.items():</span><br><span class="line">    result_raw[&apos;success&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.task_failed.items():</span><br><span class="line">    result_raw[&apos;failed&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.task_unreachable.items():</span><br><span class="line">    result_raw[&apos;unreachable&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host,result in  callback.task_skipped.items():</span><br><span class="line">    result_raw[&apos;skipped&apos;][host] = result._result</span><br><span class="line"></span><br><span class="line">for host, result in callback.task_status.items():</span><br><span class="line">    result_raw[&apos;status&apos;][host] = result</span><br><span class="line"></span><br><span class="line">print(json.dumps(result_raw,indent=4))</span><br></pre></td></tr></table></figure></p>
<p>执行示例<br>python3 play_book.py 返回类似如下结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;success&quot;: &#123;</span><br><span class="line">        &quot;192.168.1.6&quot;: &#123;</span><br><span class="line">            &quot;changed&quot;: true,</span><br><span class="line">            &quot;end&quot;: &quot;2019-01-14 04:50:06.190607&quot;,</span><br><span class="line">            &quot;stdout&quot;: &quot;&quot;,</span><br><span class="line">            &quot;cmd&quot;: &quot;touch /tmp/site.txt&quot;,</span><br><span class="line">            &quot;rc&quot;: 0,</span><br><span class="line">            &quot;start&quot;: &quot;2019-01-14 04:50:06.186466&quot;,</span><br><span class="line">            &quot;stderr&quot;: &quot;&quot;,</span><br><span class="line">            &quot;delta&quot;: &quot;0:00:00.004141&quot;,</span><br><span class="line">            &quot;invocation&quot;: &#123;</span><br><span class="line">                &quot;module_args&quot;: &#123;</span><br><span class="line">                    &quot;creates&quot;: null,</span><br><span class="line">                    &quot;executable&quot;: null,</span><br><span class="line">                    &quot;_uses_shell&quot;: true,</span><br><span class="line">                    ... 略</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;failed&quot;: &#123;&#125;,</span><br><span class="line">    &quot;unreachable&quot;: &#123;&#125;,</span><br><span class="line">    &quot;skipped&quot;: &#123;&#125;,</span><br><span class="line">    &quot;status&quot;: &#123;</span><br><span class="line">        &quot;192.168.1.6&quot;: &#123;</span><br><span class="line">            &quot;ok&quot;: 2,</span><br><span class="line">            &quot;changed&quot;: 1,</span><br><span class="line">            &quot;unreachable&quot;: 0,</span><br><span class="line">            &quot;skipped&quot;: 0,</span><br><span class="line">            &quot;failed&quot;: 0</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>adhoc重写方法如host_ok,host_failed,host_unreachable</li>
<li>playbook重写方法如task_ok,task_failed,task_unreachable,task_skipped,task_status,task_changed</li>
<li>返回如callback.task_ok.items(),其中键为host,值为result对象，result._result得到一个字典类型的详细结果</li>
</ul>
<p>&lt;&lt; 完结 &gt;&gt;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.digmyth.com/2019/01/12/ansible-Callback-02/" data-id="ck8bu1tfh000i1ojxmnvcqa4z" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  

  
</article>



  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Ceph/">Ceph</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Openstack/">Openstack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Shell/">Shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebDjango开发/">WebDjango开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebFlask开发/">WebFlask开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebSocket/">WebSocket</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web爬虫开发/">Web爬虫开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ansible/">ansible</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/声明/">声明</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器世界/">容器世界</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/02/15/linux-pacemaker-corosync/">代理ARP学习</a>
          </li>
        
          <li>
            <a href="/2020/01/20/ingress-nginx/">ingress-nginx</a>
          </li>
        
          <li>
            <a href="/2020/01/01/openvswit_vlan流表/">openvswit_vlan流表</a>
          </li>
        
          <li>
            <a href="/2019/12/15/linux-nmap详解/">nmap工具详解</a>
          </li>
        
          <li>
            <a href="/2019/12/15/linux-disk/">linux disk</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 wxq<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<!--
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
-->

<script src="https://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>